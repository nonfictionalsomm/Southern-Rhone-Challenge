<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Southern Rhône: A Wine Master's Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-content {
            max-height: 80vh;
        }
        .prose-purple a {
            color: #9333ea;
        }
        .prose-purple a:hover {
            color: #7e22ce;
        }
        .timeline-item.selected {
            background-color: #6b21a8;
            color: white;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .flashcard-front {
            background-color: #374151; /* gray-700 */
        }
        .flashcard-back {
            background-color: #4b5563; /* gray-600 */
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="main-menu" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-purple-400 mb-2 text-center">The Southern Rhône</h1>
        <h2 class="text-2xl md:text-3xl font-semibold mb-8 text-center">A Wine Master's Challenge</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl mb-8">
            <button data-module="historian" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Historian's Scroll</h3>
                <p class="text-gray-400">Order the key events that shaped the Rhône.</p>
            </button>
            <button data-module="terroir" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Terroir Architect</h3>
                <p class="text-gray-400">Master the soils, climate, and geography.</p>
            </button>
            <button data-module="ampelographer" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Ampelographer's Challenge</h3>
                <p class="text-gray-400">Identify the region's key grape varieties.</p>
            </button>
            <button data-module="lawmaker" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Lawmaker's Desk</h3>
                <p class="text-gray-400">Navigate the complexities of AOC law.</p>
            </button>
            <button data-module="gastronome" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Gastronome's Table</h3>
                <p class="text-gray-400">Explore classic food pairings and local cuisine.</p>
            </button>
            <button data-module="critic" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                <h3 class="text-xl font-bold mb-2">The Critic's Corner</h3>
                <p class="text-gray-400">Analyze vintages and iconic producers.</p>
            </button>
        </div>

        <div class="w-full max-w-4xl">
             <button data-module="flashcard" class="module-btn bg-gray-800 p-6 rounded-lg hover:bg-purple-700 transition-colors duration-300 w-full">
                <h3 class="text-xl font-bold mb-2">Flashcard Study</h3>
                <p class="text-gray-400">Build your knowledge with targeted review.</p>
            </button>
        </div>
        
        <button id="ai-settings-btn" class="mt-8 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
            ⚙️ AI Settings
        </button>
    </div>

    <div id="game-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content-wrapper" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto">
            </div>
    </div>

    <script>
        // This object contains the questions for the quiz modules
        const gameData = {
            historian: {
                title: "The Historian's Scroll",
                instructions: "For each of the 5 challenges, arrange the historical events in chronological order from earliest to latest. Tap an event to add it to your timeline, then submit your answer.",
                questions: [
                    {
                        question: "Arrange these foundational events in the Southern Rhône's history.",
                        events: [
                            { text: "Phylloxera first appears in the Southern Rhône.", date: 1866 },
                            { text: "The Papacy relocates to Avignon, boosting the region's wine prestige.", date: 1309 },
                            { text: "Greek colonists introduce viticulture near Marseille.", date: -400 }, // 4th Century BC
                            { text: "Baron Le Roy forms the Syndicat des Vignerons de Châteauneuf-du-Pape.", date: 1923 },
                            { text: "A royal decree mandates 'C.D.R.' branding on wine barrels.", date: 1737 },
                        ]
                    },
                    {
                        question: "Order the establishment of these key Southern Rhône AOCs.",
                        events: [
                            { text: "Gigondas is elevated to Cru status.", date: 1971 },
                            { text: "Châteauneuf-du-Pape becomes the first AOC in France.", date: 1936 },
                            { text: "Vacqueyras is elevated to Cru status.", date: 1990 },
                            { text: "Côtes du Rhône AOC is established.", date: 1937 },
                            { text: "Lirac is granted AOC status.", date: 1947 },
                        ]
                    },
                    {
                        question: "Place these 21st-century AOC elevations in the correct order.",
                        events: [
                            { text: "Cairanne is elevated to Cru status.", date: 2016 },
                            { text: "White wines are officially added to the Gigondas AOC.", date: 2022 },
                            { text: "Rasteau's dry red wines are elevated to Cru status.", date: 2010 },
                            { text: "Laudun is elevated to Cru status.", date: 2024 },
                            { text: "Vinsobres is elevated to Cru status.", date: 2006 },
                        ]
                    },
                    {
                        question: "Sequence the key moments in the development of quality control.",
                        events: [
                            { text: "The 'Coste du Rhône' district introduces quality regulations.", date: 1650 },
                            { text: "The INAO is established, formalizing the AOC system nationally.", date: 1935 }, // The decree was 1935, CdP was first in 1936
                            { text: "A court ruling in Orange legally defines the production rules for Châteauneuf-du-Pape.", date: 1933 },
                            { text: "The 'C.D.R.' branding is mandated by royal decree.", date: 1737 },
                            { text: "Baron Le Roy founds the first growers' syndicate in Châteauneuf-du-Pape.", date: 1923 },
                        ]
                    },
                    {
                        question: "Organize the timeline of key figures and their impact.",
                        events: [
                            { text: "Roman soldiers of the Second Legion establish a settlement at 'Jocunditas' (Gigondas).", date: 100 }, // 1st Century AD
                            { text: "Pope John XXII builds the summer palace at Châteauneuf-du-Pape.", date: 1316 }, // He was Pope from 1316
                            { text: "Baron Pierre Le Roy de Boiseaumarié drafts the rules that become the model for the AOC system.", date: 1933 },
                            { text: "Pope Clement V moves the papal court to Avignon.", date: 1309 },
                            { text: "Kermit Lynch begins championing traditional Rhône producers to an international audience.", date: 1972 }, // Kermit Lynch Wine Merchant founded
                        ]
                    }
                ]
            },
            terroir: {
                title: "The Terroir Architect",
                instructions: "Answer 10 multiple-choice questions about the geology, geography, and climate of the Southern Rhône.",
                questions: [
                    { q: "What is the primary thermal effect of the quartzite 'galets roulés' pebbles covering many Châteauneuf-du-Pape vineyards?", a: "They absorb and radiate heat, accelerating ripening.", o: ["They reflect sunlight, slowing ripening.", "They cool the soil, preserving acidity.", "They have no significant thermal effect."] },
                    { q: "Which wind's drying effect is a primary reason organic viticulture is more feasible in the Southern Rhône than in many other French regions?", a: "The Mistral", o: ["The Sirocco", "The Foehn", "The Marin"] },
                    { q: "The Southern Rhône's climate is best described as:", a: "Mediterranean", o: ["Continental", "Maritime", "Alpine"] },
                    { q: "Which soil type is most prized for its ability to produce wines with aromatic delicacy and finer tannins?", a: "Sandy soils (sableux)", o: ["Clay soils (argileux)", "Stony soils (galets)", "Limestone soils (calcaires)"] },
                    { q: "Which cru is noted for its freshness and structure, partly due to vineyards reaching elevations of up to 400 meters?", a: "Vinsobres", o: ["Tavel", "Lirac", "Costières de Nîmes"] },
                    { q: "What is the primary function of the clay subsoil often found beneath the 'galets roulés'?", a: "It acts as a water reservoir for the vines.", o: ["It cools the vine roots.", "It provides essential nutrients.", "It prevents deep root penetration."] },
                    { q: "The dramatic limestone peaks that define the terroir of Gigondas and Vacqueyras are called:", a: "The Dentelles de Montmirail", o: ["The Massif Central", "Mont Ventoux", "The Pyrenees"] },
                    { q: "A high diurnal temperature range, found at higher elevations like on the slopes of Mont Ventoux, is crucial for developing what qualities in a wine?", a: "Complex aromatics and vibrant acidity", o: ["Higher alcohol and body", "Deeper color and tannin", "Softer texture and lower alcohol"] },
                    { q: "The viticultural risk of spring frost is most acute for vineyards located in which type of setting?", a: "On flat valley floors where cold air pools.", o: ["On high-altitude, windy slopes.", "On south-facing slopes close to the river.", "In vineyards with stony soils."] },
                    { q: "The 'marin' wind, a sea breeze, primarily affects the climate of which southerly appellation?", a: "Costières de Nîmes", o: ["Vinsobres", "Gigondas", "Grignan-les-Adhémar"] },
                    { q: "The Garrigues Plateau, a key feature of Vacqueyras, is a large deposit of old alluvium from which river?", a: "The Ouvèze river", o: ["The Rhône river", "The Durance river", "The Aigues river"] },
                    { q: "Which soil type is prized for its superior water retention, a critical asset in the region's dry climate?", a: "Clay soils (argileux)", o: ["Sandy soils (sableux)", "Limestone soils (calcaires)", "Stony soils"] },
                    { q: "The name of which iconic producer is synonymous with an elegant, aromatic style derived from fine, sandy soils?", a: "Château Rayas", o: ["Château de Beaucastel", "Domaine du Vieux Télégraphe", "Clos des Papes"] },
                    { q: "What local term refers to compacted sandy or sandy-marl soils?", a: "Safres", o: ["Grès", "Galets", "Lauses"] },
                    { q: "The cool easterly air current known as the 'pontias' influences the climate of which cru?", a: "Vinsobres", o: ["Gigondas", "Cairanne", "Tavel"] },
                    { q: "What is the primary viticultural benefit of limestone soils, especially for white varieties?", a: "They provide excellent drainage and promote aromatic finesse.", o: ["They retain heat to accelerate ripening.", "They are rich in organic matter.", "They are naturally resistant to phylloxera."] },
                    { q: "The Southern Rhône Valley was geologically formed by the tectonic collision between the Massif Central and which other mountain range?", a: "The Alps", o: ["The Pyrenees", "The Jura Mountains", "The Vosges Mountains"] },
                    { q: "Which of the four main French departments of the Southern Rhône is located primarily on the left bank of the river?", a: "Vaucluse", o: ["Gard", "Ardèche", "Drôme"] },
                    { q: "The thermal radiation from 'galets roulés' leads to lower levels of which compound in the grapes at harvest?", a: "Malic acid", o: ["Tartaric acid", "Sugar", "Phenols"] },
                    { q: "The vineyards of Cairanne and Rasteau share a large hill of marl and pebbles situated between which two rivers?", a: "The Ouvèze and Aigues rivers", o: ["The Rhône and Gard rivers", "The Durance and Ouvèze rivers", "The Aigues and Durance rivers"] },
                    { q: "What is the parent material of the Dentelles de Montmirail?", a: "Mesozoic limestone and marl", o: ["Quaternary alluvium", "Tertiary sandstone", "Volcanic granite"] },
                    { q: "Which cru has the highest elevation vineyards, reaching up to 500 meters?", a: "Gigondas", o: ["Châteauneuf-du-Pape", "Tavel", "Lirac"] },
                    { q: "The Mistral wind is a double-edged sword because it reduces disease pressure but can cause what negative phenomenon?", a: "Coulure (poor fruit set)", o: ["Frost damage", "Sunburn", "Drought stress"] },
                    { q: "What is the primary viticultural challenge of sandy soils?", a: "Lower water-holding capacity", o: ["Poor drainage", "High pH", "Low heat retention"] },
                    { q: "The open geography of the Southern Rhône contrasts with what dominant topographical feature of the Northern Rhône?", a: "Steep, narrow valleys", o: ["Flat, wide plains", "Rolling hills", "Coastal plains"] },
                    { q: "Which famous mountain acts as a climatic barrier and creates unique microclimates for the Ventoux appellation?", a: "Mont Ventoux", o: ["Dentelles de Montmirail", "Massif Central", "Montagne Sainte-Victoire"] },
                    { q: "The risk of climate change is causing what phenomenon to occur earlier in the spring, increasing the risk of frost damage?", a: "Budbreak", o: ["Veraison", "Harvest", "Flowering"] },
                    { q: "Which cru is located on the western bank of the Rhône, opposite Châteauneuf-du-Pape?", a: "Lirac", o: ["Gigondas", "Vacqueyras", "Cairanne"] },
                    { q: "What is the local term for the white limestone scree found in the western part of Tavel?", a: "Lauses", o: ["Galets", "Safres", "Grès"] },
                    { q: "What is the name of the fault line whose action created the complex soils of Gigondas?", a: "Nîmes Fault", o: ["San Andreas Fault", "Alpine Fault", "Pyrenean Fault"] },
                    { q: "The city of Orange is located in which department?", a: "Vaucluse", o: ["Gard", "Drôme", "Ardèche"] },
                    { q: "Which month typically has the lowest average precipitation in the Southern Rhône?", a: "July", o: ["November", "April", "October"] },
                    { q: "The name 'Dentelles de Montmirail' translates to what?", a: "'Lace of Montmirail'", o: ["'Teeth of the Mountain'", "'Mirrored Peaks'", "'Giant's Steps'"] },
                    { q: "Based on the Winkler Index, the Southern Rhône is classified as which climate region, ideal for ripening Grenache?", a: "Region III", o: ["Region I", "Region II", "Region IV"] },
                    { q: "Which of these is NOT one of the four primary soil types identified by Inter Rhône?", a: "Volcanic basalt", o: ["Limestone soils (calcaires)", "Clay soils (argileux)", "Sandy soils (sableux)"] },
                    { q: "The Southern Rhône accounts for approximately what percentage of the entire Rhône Valley's wine production?", a: "95%", o: ["75%", "85%", "65%"] },
                    { q: "The city of Nîmes is in which department?", a: "Gard", o: ["Vaucluse", "Bouches-du-Rhône", "Drôme"] },
                    { q: "What is the approximate average number of sunshine hours per year in the Southern Rhône?", a: "2,750 hours", o: ["2,000 hours", "3,000 hours", "2,400 hours"] },
                    { q: "Which soil's thermal radiation leads to grapes with higher sugar levels and lower acidity?", a: "Galets roulés", o: ["Sandy soils", "Limestone soils", "Clay soils"] },
                    { q: "Which two crus share a border, occupying the western and eastern flanks of the same large hill?", a: "Cairanne and Rasteau", o: ["Gigondas and Vacqueyras", "Lirac and Tavel", "Vinsobres and Valréas"] },
                    { q: "The soils of Costières de Nîmes are primarily clay and what other common soil type?", a: "Galets roulés", o: ["Limestone", "Sand", "Volcanic rock"] },
                    { q: "What is the general direction of the Mistral wind?", a: "Northwesterly", o: ["Southeasterly", "Northeasterly", "Southwesterly"] },
                    { q: "What is the primary geological origin of the 'galets roulés'?", a: "Alluvial deposits from Alpine glaciers", o: ["Marine sediment from the Tertiary period", "Volcanic eruption debris", "Wind-blown loess"] },
                    { q: "Which department is home to the city of Avignon?", a: "Vaucluse", o: ["Gard", "Ardèche", "Drôme"] },
                    { q: "Which month typically has the highest average precipitation?", a: "November", o: ["July", "August", "June"] },
                    { q: "Which cru is the most northerly of the nine crus of the Southern Rhône?", a: "Vinsobres", o: ["Gigondas", "Rasteau", "Cairanne"] },
                    { q: "The term 'garrigue' refers to what?", a: "Aromatic scrubland of wild herbs", o: ["A type of soil", "A vine training system", "A local wind"] },
                    { q: "What is the average altitude in the heart of Châteauneuf-du-Pape?", a: "60-120 meters", o: ["200-300 meters", "300-400 meters", "Above 400 meters"] },
                    { q: "Vineyards on the slopes of Mont Ventoux can reach elevations of up to:", a: "600 meters", o: ["200 meters", "400 meters", "800 meters"] },
                    { q: "Which soil type is associated with powerful, structured, and deeply colored red wines?", a: "Clay soils", o: ["Sandy soils", "Limestone soils", "Gravel soils"] },
                ]
            },
            ampelographer: {
                title: "The Ampelographer's Challenge",
                instructions: "Answer 10 multiple-choice questions about the key grape varieties of the Southern Rhône. After a correct answer, you may have the option to generate an AI profile.",
                questions: [
                    { q: "Which grape typically provides the core of generous red fruit, high alcohol, and body in a classic Southern Rhône blend?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Cinsault"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "A Northern Rhône native, which variety contributes structure, savory spice, and deep color when used in Southern Rhône blends?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Carignan"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Which late-ripening variety demands significant heat and adds tannic backbone, gamey notes, and aging potential to a blend?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "The viticultural issue known as 'decline,' where the graft union swells and cracks, is a notable problem for which key Rhône grape?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Clairette"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Which of the main red grapes is most prized for its high tolerance to drought, making it vital for the region's arid climate?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Carignan"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "The traditional Gobelet (bush vine) training system is best suited for which grape due to its upright growth and wind resistance?", a: "Grenache", o: ["Syrah", "Viognier", "Marsanne"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "Due to its trailing growth habit, which grape variety must typically be supported by a trellising system?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Cinsault"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Poor fruit set caused by wind or rain during flowering, a condition known as 'coulure,' is a notorious problem for which grape?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Clairette"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "Which of the main red grapes is the latest to ripen, often requiring a long, hot season to avoid green flavors?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "A particular sensitivity to lime-induced chlorosis makes which grape variety less suitable for high-pH limestone soils?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Roussanne"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Which white grape is known for contributing a waxy texture and notes of apricot and honeysuckle to white blends?", a: "Roussanne", o: ["Clairette", "Bourboulenc", "Picardan"], subjectType: 'grape', subjectName: 'Roussanne' },
                    { q: "DNA analysis revealed that a key Northern Rhône grape is an offspring of Dureza and which other variety?", a: "Mondeuse Blanche", o: ["Pinot Noir", "Terret Noir", "Viognier"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Which permitted red grape in Châteauneuf-du-Pape is prized for adding high-toned spice and acidity to a blend?", a: "Counoise", o: ["Vaccarèse", "Muscardin", "Terret Noir"], subjectType: 'grape', subjectName: 'Counoise' },
                    { q: "The VDNs of Rasteau are based primarily on which grape family?", a: "Grenache (Noir, Gris, and Blanc)", o: ["Muscat family", "Syrah family", "Mourvèdre family"], subjectType: 'wine', subjectName: 'Rasteau VDN' },
                    { q: "Which specific Muscat variety is required for the production of Muscat de Beaumes-de-Venise?", a: "Muscat Blanc à Petits Grains", o: ["Muscat of Alexandria", "Muscat Ottonel", "Orange Muscat"], subjectType: 'grape', subjectName: 'Muscat Blanc à Petits Grains' },
                    { q: "Which variety was historically a major red grape in the Southern Rhône but is now often excluded from cru-level blends due to its rustic tannins?", a: "Carignan", o: ["Alicante Bouschet", "Aramon", "Cinsault"], subjectType: 'grape', subjectName: 'Carignan' },
                    { q: "The appellation of Clairette de Bellegarde produces white wines from 100% of which grape?", a: "Clairette", o: ["Bourboulenc", "Grenache Blanc", "Roussanne"], subjectType: 'grape', subjectName: 'Clairette' },
                    { q: "Which grape, also known as Brun Argenté, contributes color and a peppery note to Châteauneuf-du-Pape blends?", a: "Vaccarèse", o: ["Counoise", "Muscardin", "Terret Noir"], subjectType: 'grape', subjectName: 'Vaccarèse' },
                    { q: "Which of these permitted white varieties in Châteauneuf-du-Pape is considered very rare, with minimal plantings?", a: "Picardan", o: ["Clairette", "Bourboulenc", "Roussanne"], subjectType: 'grape', subjectName: 'Picardan' },
                    { q: "Which white grape is valued for retaining acidity in the hot climate, making it a key component for freshness in white blends?", a: "Bourboulenc", o: ["Roussanne", "Marsanne", "Viognier"], subjectType: 'grape', subjectName: 'Bourboulenc' },
                    { q: "Which obscure permitted grape in Châteauneuf-du-Pape is known for its floral aromatics?", a: "Muscardin", o: ["Vaccarèse", "Counoise", "Terret Noir"], subjectType: 'grape', subjectName: 'Muscardin' },
                    { q: "The most widely planted white grape for AOC wines in the Southern Rhône is a color mutation of which red grape?", a: "Grenache Noir", o: ["Syrah", "Pinot Noir", "Cinsault"], subjectType: 'grape', subjectName: 'Grenache Blanc' },
                    { q: "Which of the main red grapes has a late budbreak, offering it some protection from spring frosts?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "To preserve genetic heritage, a conservatory containing over 360 different clones of which grape was established in the Rhône?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Viognier"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "Which pair of secondary grapes, permitted in Châteauneuf-du-Pape, are known to exist in Noir, Blanc, and Gris color mutations?", a: "Picpoul and Grenache", o: ["Counoise and Vaccarèse", "Clairette and Bourboulenc", "Roussanne and Marsanne"], subjectType: 'grape', subjectName: 'Picpoul' },
                    { q: "The red wines of Châtillon-en-Diois, a cooler region, must be at least 75% which grape?", a: "Gamay", o: ["Syrah", "Grenache", "Pinot Noir"], subjectType: 'grape', subjectName: 'Gamay' },
                    { q: "Clairette de Die Méthode Ancestrale must contain at least 75% of which grape?", a: "Muscat Blanc à Petits Grains", o: ["Clairette", "Aligoté", "Chardonnay"], subjectType: 'wine', subjectName: 'Clairette de Die' },
                    { q: "In the Duché d’Uzès AOC, which grape must be the majority component for white wines?", a: "Viognier", o: ["Grenache Blanc", "Roussanne", "Marsanne"], subjectType: 'grape', subjectName: 'Viognier' },
                    { q: "What is the famous saying describing a certain grape's ideal growing conditions: 'its face in the hot sun and its feet in the water'?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "Which of the GSM trio has thick skins rich in phenolics, contributing significant tannin and aging potential?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Carignan"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "Which grape is known to produce wines with high alcohol and a flavor profile of strawberry and raspberry, but can also oxidize easily?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Cinsault"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "Which grape is known to add notes of black pepper, smoked meat, and violets to a blend?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Cinsault"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "The white version of which major grape provides structure and notes of green apple and citrus to white blends?", a: "Grenache Blanc", o: ["Picpoul Blanc", "Clairette", "Bourboulenc"], subjectType: 'grape', subjectName: 'Grenache Blanc' },
                    { q: "The Australian name for Mourvèdre is:", a: "Mataro", o: ["Shiraz", "Durif", "Tarrango"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "The variety 'Clairette Rosé' is a permitted variety in which major appellation?", a: "Châteauneuf-du-Pape", o: ["Tavel", "Gigondas", "Vacqueyras"], subjectType: 'grape', subjectName: 'Clairette' },
                    { q: "Which red grape variety's name is thought to derive from the French verb for 'to advise', for its moderating influence in a blend?", a: "Counoise", o: ["Vaccarèse", "Muscardin", "Syrah"], subjectType: 'grape', subjectName: 'Counoise' },
                    { q: "Which grape is the principal white grape of Lirac, often blended with Clairette and Bourboulenc?", a: "Grenache Blanc", o: ["Roussanne", "Viognier", "Marsanne"], subjectType: 'grape', subjectName: 'Grenache Blanc' },
                    { q: "The red wines of Costières de Nîmes are typically blends with a high proportion of which grape variety?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Carignan"], subjectType: 'wine', subjectName: 'Costières de Nîmes' },
                    { q: "What is the key aromatic contribution of Roussanne to a white blend?", a: "Herbal, tea-like notes and aromas of apricot and honeysuckle", o: ["Bright citrus and floral notes", "Green apple and mineral tones", "Tropical fruit and vanilla"], subjectType: 'grape', subjectName: 'Roussanne' },
                    { q: "How many certified clones of Syrah exist in France?", a: "12", o: ["24", "6", "18"], subjectType: 'grape', subjectName: 'Syrah' },
                    { q: "Which of the main GSM grapes has a mid-to-late season ripening period?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Cinsault"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "The Spanish name for Mourvèdre is:", a: "Monastrell", o: ["Garnacha", "Tempranillo", "Carinena"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "Which grape's thick skins make it relatively resistant to grey rot?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "Which grape provides finesse and freshness, and is often utilized for rosé wines?", a: "Cinsault", o: ["Mourvèdre", "Syrah", "Carignan"], subjectType: 'grape', subjectName: 'Cinsault' },
                    { q: "Which permitted red grape in Châteauneuf-du-Pape has a name meaning 'cow-keeper'?", a: "Vaccarèse", o: ["Counoise", "Muscardin", "Terret Noir"], subjectType: 'grape', subjectName: 'Vaccarèse' },
                    { q: "Which red grape has an early budbreak, making it particularly vulnerable to spring frosts?", a: "Grenache", o: ["Mourvèdre", "Syrah", "Carignan"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "The white wines of Châtillon-en-Diois are made from Chardonnay and which other Burgundian grape?", a: "Aligoté", o: ["Pinot Blanc", "Gamay Blanc", "Sauvignon Blanc"], subjectType: 'wine', subjectName: 'Châtillon-en-Diois' },
                    { q: "Which grape provides the body, alcohol, and generous red fruit to the classic GSM blend?", a: "Grenache", o: ["Syrah", "Mourvèdre", "Carignan"], subjectType: 'grape', subjectName: 'Grenache' },
                    { q: "Which grape provides a savory, gamey complexity and is key for a wine's aging potential?", a: "Mourvèdre", o: ["Grenache", "Syrah", "Cinsault"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                ]
            },
            lawmaker: {
                title: "The Lawmaker's Desk",
                instructions: "Answer 10 multiple-choice questions about the appellation laws and winemaking regulations of the Southern Rhône.",
                questions: [
                    { q: "What is the minimum potential alcohol for red wines from Châteauneuf-du-Pape, Gigondas, and Vacqueyras?", a: "12.5%", o: ["12.0%", "13.0%", "13.5%"] },
                    { q: "Which appellation is the only Cru in the Rhône dedicated exclusively to rosé?", a: "Tavel", o: ["Lirac", "Gigondas", "Rasteau"] },
                    { q: "In Châteauneuf-du-Pape, what is the legal term for the mandatory declassification of at least 2% of the harvest?", a: "Le râpé", o: ["Le tri", "La saignée", "Le délestage"] },
                    { q: "What is the maximum permitted yield for red Châteauneuf-du-Pape?", a: "35 hl/ha", o: ["40 hl/ha", "36 hl/ha", "45 hl/ha"] },
                    { q: "Which cru was the first Côtes du Rhône Village to be promoted to its own appellation in 1971?", a: "Gigondas", o: ["Vacqueyras", "Cairanne", "Vinsobres"] },
                    { q: "The rules for red Vacqueyras state that Grenache, Syrah, and Mourvèdre must constitute at least what percentage of the blend combined?", a: "90%", o: ["80%", "75%", "95%"] },
                    { q: "Which viticultural practice is legally forbidden in Châteauneuf-du-Pape but permitted in Gigondas and Vacqueyras?", a: "Mechanical Harvesting", o: ["Irrigation", "Use of pesticides", "Cane pruning"] },
                    { q: "The process of adding grape spirit to arrest fermentation for VDN wines is called:", a: "Mutage", o: ["Chaptalization", "Bâtonnage", "Soutirage"] },
                    { q: "Which tier of the Rhône Valley hierarchy sits just below the Crus?", a: "Côtes du Rhône Villages + Named Village", o: ["Côtes du Rhône Villages", "Côtes du Rhône", "IGP Méditerranée"] },
                    { q: "How many communes are included in the foundational Côtes du Rhône AOP?", a: "171", o: ["95", "22", "18"] },
                    { q: "In Gigondas, what is the minimum combined percentage of Syrah and Mourvèdre required in red blends?", a: "15%", o: ["10%", "20%", "25%"] },
                    { q: "What does the Rasteau VDN label term 'Grenat' signify?", a: "A non-oxidative style red VDN, meant to be drunk young and fresh", o: ["An oxidative style red VDN", "A white VDN aged for 5 years", "A rosé VDN"] },
                    { q: "The 'méthode dioise ancestrale' used for Clairette de Die results in a wine with what characteristics?", a: "Lower alcohol (7-9%) and high residual sugar (min 35 g/l)", o: ["High alcohol and bone dry", "Medium alcohol and off-dry", "High alcohol and very sweet"] },
                    { q: "The oversight of which appellation was transferred from Languedoc to the Rhône authorities in 2004?", a: "Costières de Nîmes", o: ["Luberon", "Ventoux", "Duché d’Uzès"] },
                    { q: "The producers of which appellation successfully rebranded from 'Côtes du Tricastin' in 2010 to avoid association with a nuclear plant?", a: "Grignan-les-Adhémar", o: ["Côtes du Vivarais", "Ventoux", "Luberon"] },
                    { q: "When supplemental irrigation is permitted by prefectural decree, what is the legal consequence for the grower?", a: "They must adhere to a significantly lower maximum yield.", o: ["They must pay a higher tax.", "They can only use certain grape varieties.", "They must label the wine as irrigated."] },
                    { q: "The new AOC for white Gigondas, approved for the 2023 vintage, is primarily based on which grape variety?", a: "Clairette", o: ["Grenache Blanc", "Roussanne", "Viognier"] },
                    { q: "Which Côtes du Rhône-Villages with a named village is permitted to produce red wine only?", a: "Plan de Dieu", o: ["Laudun", "Sablet", "Chusclan"] },
                    { q: "What does the term 'Hors d'âge' on a bottle of Rasteau VDN signify?", a: "A minimum of five years of aging", o: ["A minimum of ten years of aging", "A vintage-dated VDN", "A VDN from a single vineyard"] },
                    { q: "Lirac holds the distinction of being the first cru in the Rhône to be recognized for what?", a: "The production of all three colors of wine (red, white, and rosé)", o: ["Exclusively producing rosé", "Being 100% biodynamic", "Mandating 100% Grenache"] },
                    { q: "In what year was the Rasteau appellation specifically for VDNs created?", a: "1944", o: ["1936", "1971", "2010"] },
                    { q: "While Châteauneuf-du-Pape famously allows 18 varieties, what is the minimum required percentage for any single grape?", a: "0% - there are no mandated percentages", o: ["Minimum 50% Grenache", "Maximum 80% Grenache", "Minimum 10% Syrah"] },
                    { q: "What is the official document that outlines all the production rules for a given AOP?", a: "Cahier des charges", o: ["Le décret", "La loi", "Le règlement"] },
                    { q: "Which of the Diois appellations produces a dry, traditional method sparkling wine?", a: "Crémant de Die", o: ["Clairette de Die", "Châtillon-en-Diois", "Coteaux de Die"] },
                    { q: "The red wines of Vinsobres must be a blend dominated by Grenache and which other two varieties?", a: "Syrah and/or Mourvèdre", o: ["Cinsault and/or Carignan", "Counoise and/or Vaccarèse", "Syrah and/or Cinsault"] },
                    { q: "How many villages are permitted to append their name to the Côtes du Rhône Villages AOP?", a: "22", o: ["95", "171", "18"] },
                    { q: "In Gigondas, what is the maximum percentage of Grenache allowed in red blends?", a: "80%", o: ["50%", "70%", "90%"] },
                    { q: "The port of Roquemaure, an important 18th-century wine center, is located within which modern AOP?", a: "Lirac", o: ["Tavel", "Châteauneuf-du-Pape", "Vacqueyras"] },
                    { q: "The AOP of Cairanne was most recently promoted from Côtes du Rhône-Villages status in what year?", a: "2016", o: ["2010", "2006", "1990"] },
                    { q: "Which AOP, a single commune within Costières de Nîmes, produces white wines from 100% Clairette?", a: "Clairette de Bellegarde", o: ["Clairette de Die", "Coteaux de Die", "Clairette du Languedoc"] },
                    { q: "What is the release date for red Vacqueyras?", a: "January 15 of the year following harvest", o: ["December 1 of the year of harvest", "March 15 of the year following harvest", "September 1 of the year following harvest"] },
                    { q: "The original 1936 AOC rules for Châteauneuf-du-Pape notably disallowed the production of which style of wine?", a: "Rosé", o: ["Vin Doux Naturel", "Sparkling", "Single-varietal Syrah"] },
                    { q: "What is the minimum residual sugar for Muscat de Beaumes-de-Venise?", a: "100 g/L", o: ["50 g/L", "120 g/L", "80 g/L"] },
                    { q: "How many communes are covered by the Côtes du Rhône-Villages AOP?", a: "95", o: ["171", "22", "50"] },
                    { q: "What is the minimum ABV of the neutral grape spirit used for mutage?", a: "96%", o: ["85%", "90%", "77%"] },
                    { q: "What is the former name for the IGP classification?", a: "Vin de Pays", o: ["Vin de Table", "VDQS", "Vin de France"] },
                    { q: "What is the maximum yield for the newly permitted white wines of Gigondas?", a: "40 hl/ha", o: ["35 hl/ha", "36 hl/ha", "45 hl/ha"] },
                    { q: "What is a key legal difference between Côtes du Rhône and Côtes du Rhône-Villages?", a: "Villages has stricter rules, including lower yields and higher minimum alcohol.", o: ["Villages can only be red.", "Villages must be 100% Grenache.", "There is no legal difference."] },
                    { q: "Which was the most recently elevated Southern Rhône Cru as of September 2024?", a: "Laudun", o: ["Cairanne", "Vinsobres", "Rasteau"] },
                    { q: "The term 'rancio' on a bottle of Rasteau indicates what production method?", a: "Deliberate oxidation, often by leaving wine in open barrels exposed to sunlight", o: ["Carbonic maceration", "Cryo-extraction", "Méthode ancestrale"] },
                    { q: "What is the minimum planting density for Châteauneuf-du-Pape?", a: "3,000 vines per hectare", o: ["2,500 vines per hectare", "4,000 vines per hectare", "5,000 vines per hectare"] },
                    { q: "What is the release date for red Gigondas?", a: "March 15 of the year following harvest", o: ["January 15 of the year following harvest", "December 1 of the year of harvest", "November 1 of the year following harvest"] },
                    { q: "What does the term 'Tuilé' on a bottle of Rasteau VDN indicate?", a: "A tawny, oxidatively aged red VDN", o: ["A young, fresh red VDN", "An amber, oxidatively aged white VDN", "A VDN aged for at least 10 years"] },
                    { q: "Which two former Côtes du Rhône-Villages were promoted to full AOP status in 2005 and 2006 respectively?", a: "Beaumes-de-Venise and Vinsobres", o: ["Gigondas and Vacqueyras", "Cairanne and Rasteau", "Laudun and Sablet"] },
                    { q: "The French governmental body that manages the AOC system is called:", a: "INAO", o: ["FranceAgriMer", "Inter Rhône", "Syndicat Général des Vignerons"] },
                    { q: "Is chaptalization a common practice in the Southern Rhône?", a: "No, it is rarely necessary due to the warm climate.", o: ["Yes, it is used in almost every vintage.", "It is only allowed for white wines.", "It is only allowed for VDNs."] },
                    { q: "In Vacqueyras, what is the minimum percentage of Grenache required for red wines?", a: "50%", o: ["40%", "60%", "70%"] },
                    { q: "Which of these is NOT one of the three tiers of the French quality pyramid?", a: "Vin de Terroir", o: ["Vin de France", "Indication Géographique Protégée (IGP)", "Appellation d'Origine Protégée (AOP)"] },
                    { q: "The term 'Cru' in the Rhône designates an appellation at the top of which specific hierarchy?", a: "The Rhône Valley Hierarchy", o: ["The French National Hierarchy", "The Burgundy Hierarchy", "The Bordeaux Hierarchy"] },
                    { q: "Which mandatory action in Châteauneuf-du-Pape ensures that only healthy, fully ripe fruit is used?", a: "Le tri (sorting)", o: ["Le râpé (declassification)", "Mutage (fortification)", "Élevage (aging)"] },
                ]
            },
            gastronome: {
                title: "The Gastronome's Table",
                instructions: "Answer 10 multiple-choice questions about the cuisine, ingredients, and classic pairings of the Southern Rhône. After a correct answer, you may have the option to generate an AI explanation.",
                questions: [
                    { q: "Which hearty beef stew, slow-cooked in red wine and herbs, is a quintessential dish of the region?", a: "Daube Provençale", o: ["Boeuf Bourguignon", "Coq au Vin", "Pot-au-Feu"], subjectType: 'dish', subjectName: 'Daube Provençale' },
                    { q: "A mature, structured red from Gigondas or Châteauneuf-du-Pape is the classic pairing for what slow-cooked beef stew?", a: "Daube Provençale", o: ["Bouillabaisse", "Tian de Légumes", "Tapenade"], subjectType: 'wine_pairing', subjectName: 'Daube Provençale' },
                    { q: "The powerful, structured nature of a Tavel rosé allows it to stand up to which potent flavors in Bouillabaisse?", a: "Saffron and garlic", o: ["Tomato and basil", "Lemon and dill", "Cream and butter"], subjectType: 'wine_pairing', subjectName: 'Bouillabaisse' },
                    { q: "The name for the flavorful spread 'tapenade' comes from the Provençal word for which of its ingredients?", a: "Capers (tapenas)", o: ["Olives", "Anchovies", "Garlic"], subjectType: 'dish', subjectName: 'Tapenade' },
                    { q: "Which PGI-protected melon is celebrated for its intense aroma and sweetness?", a: "Melon de Cavaillon", o: ["Melon de Lectoure", "Melon de Guadeloupe", "Charentais Melon"], subjectType: 'ingredient', subjectName: 'Melon de Cavaillon' },
                    { q: "The region's traditional pomace brandy, distilled from grape skins and seeds, is called:", a: "Marc de Provence", o: ["Cognac", "Armagnac", "Calvados"], subjectType: 'spirit', subjectName: 'Marc de Provence' },
                    { q: "The 'louche' effect, where a spirit turns milky with water, is characteristic of what beverage?", a: "Pastis", o: ["Génépi", "Marc de Provence", "Chartreuse"], subjectType: 'spirit', subjectName: 'Pastis' },
                    { q: "The sensory note of 'garrigue' in a wine directly mirrors the aroma of what common culinary ingredient blend?", a: "Herbes de Provence", o: ["Bouquet garni", "Fines herbes", "Quatre épices"], subjectType: 'ingredient', subjectName: 'Herbes de Provence' },
                    { q: "The alpine liqueur 'Génépi' is made from the flowering tops of which plant?", a: "Wormwood (Artemisia)", o: ["Gentian Root", "Juniper Berries", "Anise"], subjectType: 'liqueur', subjectName: 'Génépi' },
                    { q: "What is the local Provençal dialect word for wild thyme, which is also used to make a liqueur?", a: "Farigoule", o: ["Garrigue", "Mistral", "Safres"], subjectType: 'liqueur', subjectName: 'Farigoule' },
                    { q: "Which PGI-protected ancient grain is used to make a traditional bread ('pain d'épeautre') in Provence?", a: "Petit épeautre de Haute-Provence (spelt)", o: ["Farro", "Kamut", "Buckwheat"], subjectType: 'ingredient', subjectName: 'Petit épeautre' },
                    { q: "A 'tian' is a Provençal dish best described as what?", a: "A gratin of layered, baked vegetables", o: ["A cold vegetable soup", "A type of sausage", "A savory pastry"], subjectType: 'dish', subjectName: 'Tian de Légumes' },
                    { q: "What is the defining aromatic and flavor component in the mayonnaise-like sauce 'rouille'?", a: "Garlic and saffron", o: ["Lemon and dill", "Mustard and tarragon", "Tomato and basil"], subjectType: 'dish', subjectName: 'Rouille' },
                    { q: "The potent, anise-flavored spirit Pastis is culturally associated with which classic Provençal lawn game?", a: "Pétanque", o: ["Croquet", "Badminton", "Bocce"], subjectType: 'spirit', subjectName: 'Pastis' },
                    { q: "A 'digestif', such as an aged Marc de Provence, is typically consumed at what point during a meal?", a: "After the meal, to aid digestion", o: ["Before the meal, as an apéritif", "During the main course", "With dessert"], subjectType: 'spirit', subjectName: 'Marc de Provence' },
                    { q: "A young, fruity Côtes du Rhône red or rosé is a classic pairing for which vegetable-focused dish?", a: "Tian de Légumes", o: ["Daube Provençale", "Bouillabaisse", "Roasted Lamb"], subjectType: 'wine_pairing', subjectName: 'Tian de Légumes' },
                    { q: "Which PDO-protected purple fig is a celebrated sweet delicacy of the region?", a: "Figue de Solliès", o: ["Calimyrna Fig", "Black Mission Fig", "Brown Turkey Fig"], subjectType: 'ingredient', subjectName: 'Figue de Solliès' },
                    { q: "A rich white Châteauneuf-du-Pape is an excellent alternative pairing for which complex seafood dish?", a: "Bouillabaisse", o: ["Steak Frites", "Coq au Vin", "Cassoulet"], subjectType: 'wine_pairing', subjectName: 'Bouillabaisse' },
                    { q: "Which PDO-protected olive is a specialty of the western part of the Southern Rhône?", a: "Olive de Nîmes", o: ["Picholine", "Kalamata", "Niçoise"], subjectType: 'ingredient', subjectName: 'Olive de Nîmes' },
                    { q: "What type of meat is most classically roasted with garlic, rosemary, and thyme in Provence?", a: "Lamb (Agneau de Provence)", o: ["Pork", "Chicken", "Veal"], subjectType: 'dish', subjectName: 'Agneau de Provence' },
                    { q: "A full-bodied Vacqueyras red is an ideal pairing for what roasted meat dish?", a: "Agneau de Provence (roast lamb)", o: ["Poached Salmon", "Grilled Shrimp", "Oysters on the half shell"], subjectType: 'wine_pairing', subjectName: 'Agneau de Provence' },
                    { q: "Aged Marc de Provence often develops what kind of flavor notes from barrel aging?", a: "Gingerbread, dried fruit, and toasted almonds", o: ["Fresh apple, pear, and citrus", "Anise, fennel, and licorice", "Juniper, coriander, and botanicals"], subjectType: 'spirit', subjectName: 'Marc de Provence' },
                    { q: "The pairing of a Gigondas with a Daube is an example of which pairing principle?", a: "Complementary pairing (matching intensity and echoing herbal notes)", o: ["Contrasting pairing (sweet and sour)", "Textural pairing only", "No specific principle"], subjectType: 'wine_pairing', subjectName: 'Daube Provençale' },
                    { q: "Which two ingredients are finely chopped or puréed to form the base of a tapenade?", a: "Black olives and capers", o: ["Green olives and almonds", "Artichokes and lemon", "Sun-dried tomatoes and basil"], subjectType: 'dish', subjectName: 'Tapenade' },
                    { q: "The cuisine of the Southern Rhône is most accurately described as a part of which broader culinary tradition?", a: "Mediterranean cuisine", o: ["Continental cuisine", "Alpine cuisine", "Atlantic cuisine"], subjectType: 'gastronomy', subjectName: 'Provençal Cuisine' },
                    { q: "What is the key to a great Bouillabaisse considered to be?", a: "The quality and flavor of the broth", o: ["The type of bread served", "The amount of rouille", "The size of the fish"], subjectType: 'dish', subjectName: 'Bouillabaisse' },
                    { q: "The term 'Provençal' in a dish name almost always implies the use of which ingredients?", a: "Garlic, olive oil, and tomatoes or herbs", o: ["Butter, cream, and mushrooms", "Soy sauce, ginger, and garlic", "Chilies, lime, and cilantro"], subjectType: 'gastronomy', subjectName: 'Provençal Cuisine' },
                    { q: "Besides wine, what is the most important agricultural product with a PDO in the region?", a: "Olive oil (Huile d'olive de Provence)", o: ["Cheese", "Beef", "Wheat"], subjectType: 'ingredient', subjectName: 'Olive Oil' },
                    { q: "What gives Pastis its dominant flavor?", a: "Anise", o: ["Juniper", "Wormwood", "Gentian root"], subjectType: 'spirit', subjectName: 'Pastis' },
                    { q: "What is the role of the anchovy in a traditional tapenade?", a: "To provide a salty, umami depth of flavor", o: ["To add a fishy aroma", "To thicken the spread", "To make it spicy"], subjectType: 'dish', subjectName: 'Tapenade' },
                    { q: "The gastronomic culture of the region emphasizes what core principle?", a: "The use of fresh, seasonal, and local ingredients", o: ["The use of complex, imported spices", "A focus on molecular gastronomy", "A preference for fried foods"], subjectType: 'gastronomy', subjectName: 'Provençal Cuisine' },
                    { q: "What is the primary cooking fat of Provence?", a: "Olive Oil", o: ["Butter", "Lard", "Duck Fat"], subjectType: 'ingredient', subjectName: 'Olive Oil' },
                    { q: "What is the French term for a pre-dinner drink intended to stimulate the appetite?", a: "Apéritif", o: ["Digestif", "Amuse-bouche", "Entrée"], subjectType: 'culture', subjectName: 'Apéritif' },
                    { q: "What is 'rascasse', an essential ingredient for Bouillabaisse?", a: "A bony rockfish (scorpionfish)", o: ["A type of shellfish", "A variety of seaweed", "A local squid"], subjectType: 'ingredient', subjectName: 'Rascasse' },
                    { q: "The flavor of wild rosemary in 'garrigue' is often a key tasting note in red wines based on which grape?", a: "Mourvèdre", o: ["Grenache", "Cinsault", "Carignan"], subjectType: 'grape', subjectName: 'Mourvèdre' },
                    { q: "What are the four primary herbs in a typical 'Herbes de Provence' blend?", a: "Thyme, rosemary, savory, and oregano", o: ["Basil, parsley, tarragon, and chives", "Cilantro, cumin, coriander, and chili", "Dill, fennel, mint, and parsley"], subjectType: 'ingredient', subjectName: 'Herbes de Provence' },
                    { q: "A crisp, dry rosé from the broader Côtes du Rhône AOP would be a good match for what simple summer appetizer?", a: "Tapenade on toast", o: ["Foie gras", "Beef tartare", "Escargots"], subjectType: 'wine_pairing', subjectName: 'Tapenade' },
                    { q: "What is the texture of a classic Daube Provençale?", a: "Meltingly tender beef in a rich, thick sauce", o: ["Firm, grilled beef strips", "Crispy, fried beef cubes", "Minced raw beef"], subjectType: 'dish', subjectName: 'Daube Provençale' },
                    { q: "What is the traditional beverage served with tapenade during an 'apéritif'?", a: "Pastis", o: ["Red wine", "White wine", "Beer"], subjectType: 'pairing', subjectName: 'Tapenade' },
                    { q: "Which key flavoring gives Bouillabaisse its distinctive color and aroma?", a: "Saffron", o: ["Paprika", "Turmeric", "Cinnamon"], subjectType: 'ingredient', subjectName: 'Saffron' },
                    { q: "The slightly bitter, herbal character of Génépi makes it a classic...", a: "Alpine digestif", o: ["Sweet apéritif", "Fruity liqueur", "Spiced wine"], subjectType: 'liqueur', subjectName: 'Génépi' },
                    { q: "What is the primary function of the 'rouille' served with the fish stew?", a: "To enrich the broth and add flavor to the toast.", o: ["To cool down the stew.", "To be eaten as a side dish.", "To garnish the fish."], subjectType: 'dish', subjectName: 'Rouille' },
                    { q: "A young, unoaked white Côtes du Rhône would be a refreshing pairing for which simple dish?", a: "Tian de Légumes", o: ["Daube Provençale", "Roast Lamb", "Bouillabaisse"], subjectType: 'wine_pairing', subjectName: 'Tian de Légumes' },
                    { q: "The sweetness of which PDO fruit makes it a classic pairing for savory items like prosciutto and goat cheese?", a: "Figue de Solliès", o: ["Melon de Cavaillon", "Olive de Nîmes", "Cherry from Ventoux"], subjectType: 'ingredient', subjectName: 'Figue de Solliès' },
                    { q: "The sensory bridge between the region's food and wine is often attributed to the aroma of what?", a: "Garrigue / Herbes de Provence", o: ["The sea", "Truffles", "Citrus groves"], subjectType: 'gastronomy', subjectName: 'Garrigue' },
                    { q: "Distillation of Marc de Provence is often carried out using what kind of equipment?", a: "Mobile stills", o: ["Large pot stills", "Continuous column stills", "Small alembic stills"], subjectType: 'spirit', subjectName: 'Marc de Provence' },
                ]
            },
            critic: {
                title: "The Critic's Corner",
                instructions: "Answer 10 multiple-choice questions about the vintages, producers, and market context of the Southern Rhône. After a correct answer, you may have the option to generate an AI tasting note.",
                questions: [
                    { q: "Which iconic producer is famous for an ethereal, aromatic style derived from 100% Grenache grown on unique, cool, sandy soils?", a: "Château Rayas", o: ["Château de Beaucastel", "Domaine du Vieux Télégraphe", "Clos des Papes"], subjectType: 'producer', subjectName: 'Château Rayas' },
                    { q: "Pioneers of biodynamics in the region, which estate is known for using a high proportion of Mourvèdre and all permitted varieties in its blend?", a: "Château de Beaucastel", o: ["Château Rayas", "Henri Bonneau", "Domaine Charvin"], subjectType: 'producer', subjectName: 'Château de Beaucastel' },
                    { q: "Which vintage is widely considered a benchmark year, combining power and concentration with remarkable freshness and balance?", a: "2016", o: ["2014", "2018", "2021"], subjectType: 'vintage', subjectName: '2016 Southern Rhône Vintage' },
                    { q: "The rare and legendary 'Hommage à Jacques Perrin' is the top cuvée from which iconic estate?", a: "Château de Beaucastel", o: ["Henri Bonneau", "Domaine du Pégau", "Château Rayas"], subjectType: 'wine', subjectName: 'Château de Beaucastel Hommage à Jacques Perrin' },
                    { q: "Which estate is a benchmark for elegance and consistency, famously producing only one red and one white Châteauneuf-du-Pape?", a: "Clos des Papes", o: ["Domaine du Vieux Télégraphe", "Château Rayas", "Château de Beaucastel"], subjectType: 'producer', subjectName: 'Clos des Papes' },
                    { q: "The powerful, structured style of Domaine du Vieux Télégraphe is a classic expression of which specific terroir?", a: "The stony La Crau plateau", o: ["The cool, sandy soils of Pignan", "The limestone slopes of the Dentelles", "The alluvial plains of the Ouvèze"], subjectType: 'place', subjectName: 'La Crau plateau, Châteauneuf-du-Pape' },
                    { q: "The 'Réserve des Célestins' is the mythical top cuvée from which traditionalist icon?", a: "Henri Bonneau", o: ["Château de Beaucastel", "Château Rayas", "Domaine de la Janasse"], subjectType: 'wine', subjectName: 'Henri Bonneau Réserve des Célestins' },
                    { q: "The stylistic comparison of Château Rayas to 'Burgundy' refers to what qualities in the wine?", a: "Its focus on perfume, elegance, and finesse rather than raw power", o: ["Its high level of tannin and color", "Its use of Cabernet Sauvignon", "Its tropical fruit flavors"], subjectType: 'producer', subjectName: 'Château Rayas' },
                    { q: "Which vintage is described as 'powerful, structured, and age-worthy' and often compared to the benchmark 2005?", a: "2010", o: ["2007", "2009", "2011"], subjectType: 'vintage', subjectName: '2010 Southern Rhône Vintage' },
                    { q: "Which vintage is described as 'sensuous, sexy, and opulent' with 'silky textures'?", a: "2007", o: ["2008", "2013", "2014"], subjectType: 'vintage', subjectName: '2007 Southern Rhône Vintage' },
                    { q: "The 'modernist' approach to winemaking often involves what two key cellar techniques?", a: "Destemming grapes and using smaller, sometimes new, oak barrels", o: ["Whole-cluster fermentation and aging in concrete", "Carbonic maceration and aging in foudres", "Foot-stomping and aging in amphorae"], subjectType: 'winemaking', subjectName: 'Modernist Winemaking' },
                    { q: "What is the hallmark aging vessel for a 'traditionalist' producer like Henri Bonneau?", a: "Large, old oak casks called 'foudres'", o: ["New 225-liter barriques", "Stainless steel tanks", "Concrete eggs"], subjectType: 'winemaking', subjectName: 'Traditionalist Winemaking' },
                    { q: "The wines of the 2018 vintage were highly variable due to what widespread climatic problem?", a: "Severe mildew pressure from a wet spring", o: ["Extreme drought", "Widespread frost", "A heatwave during harvest"], subjectType: 'vintage', subjectName: '2018 Southern Rhône Vintage' },
                    { q: "The wines of the 2013 vintage were lean and low-yielding primarily due to what phenomenon?", a: "Catastrophic coulure (poor fruit set) in Grenache", o: ["A very hot and dry summer", "Wildfires near the vineyards", "Excessive rainfall during harvest"], subjectType: 'vintage', subjectName: '2013 Southern Rhône Vintage' },
                    { q: "Domaine le Sang des Cailloux is considered a 'Value Champion' and leading producer in which cru?", a: "Vacqueyras", o: ["Gigondas", "Cairanne", "Rasteau"], subjectType: 'producer', subjectName: 'Domaine le Sang des Cailloux' },
                    { q: "Producers like Domaine l'Anglore are leading a 'natural wine' renaissance in which appellation?", a: "Tavel", o: ["Lirac", "Châteauneuf-du-Pape", "Gigondas"], subjectType: 'producer', subjectName: 'Domaine l\'Anglore' },
                    { q: "The proliferation of highly-priced, single-vineyard or special selection wines, known as 'Special Cuvées', began in which decade?", a: "Late 1980s", o: ["1970s", "1990s", "2000s"], subjectType: 'market', subjectName: 'Special Cuvées' },
                    { q: "How is the 2020 vintage generally characterized in comparison to the 2019 vintage?", a: "More balanced and fresh, with less power but fine tannins", o: ["More powerful and alcoholic", "Lighter and more acidic", "A complete washout"], subjectType: 'vintage', subjectName: '2020 Southern Rhône Vintage' },
                    { q: "The Brunier family is the proprietor of which iconic estate?", a: "Domaine du Vieux Télégraphe", o: ["Château de Beaucastel", "Château Rayas", "Clos des Papes"], subjectType: 'producer', subjectName: 'Domaine du Vieux Télégraphe' },
                    { q: "The wines from the high-elevation cru of Vinsobres are noted for what particular quality?", a: "Freshness and structure", o: ["Opulence and high alcohol", "Lightness and simplicity", "Oxidative character"], subjectType: 'wine_style', subjectName: 'Vinsobres' },
                    { q: "The use of ovoid concrete tanks ('concrete eggs') is a modern technique used to achieve what effect in the wine?", a: "Enhanced texture and freshness without oak flavor", o: ["Increased oak flavor and tannin", "Faster aging and oxidation", "Higher alcohol content"], subjectType: 'winemaking', subjectName: 'Concrete Eggs' },
                    { q: "Whole-cluster fermentation, a traditionalist technique, contributes what characteristics to a wine?", a: "Additional tannins and spicy, herbal complexities", o: ["Softer tannins and fruitier notes", "Lower alcohol and lighter body", "Higher acidity and floral aromas"], subjectType: 'winemaking', subjectName: 'Whole-Cluster Fermentation' },
                    { q: "Which 'Value Champion' estate is considered a benchmark producer in Gigondas?", a: "Château de St-Cosme", o: ["Domaine le Sang des Cailloux", "Domaine Gramenon", "Domaine de la Solitude"], subjectType: 'producer', subjectName: 'Château de St-Cosme' },
                    { q: "Who is the influential winemaker behind Clos des Papes, known for his consistent and elegant style?", a: "Paul-Vincent Avril", o: ["Emmanuel Reynaud", "Marc Perrin", "Daniel Brunier"], subjectType: 'producer', subjectName: 'Clos des Papes' },
                    { q: "The Reynaud family is the proprietor of which iconoclastic estate?", a: "Château Rayas", o: ["Château de Beaucastel", "Domaine du Vieux Télégraphe", "Guigal"], subjectType: 'producer', subjectName: 'Château Rayas' },
                    { q: "Which 'Value Champion' is known for making exceptional biodynamic wines under the basic Côtes du Rhône AOP?", a: "Domaine Gramenon", o: ["Château de Fonsalette", "Domaine Charvin", "Domaine Santa Duc"], subjectType: 'producer', subjectName: 'Domaine Gramenon' },
                    { q: "A wine critic describing a wine with notes of 'garrigue' is referring to the scent of what?", a: "Wild Provençal herbs (thyme, rosemary, lavender)", o: ["Barnyard and leather", "Black truffle and earth", "Toast and vanilla from new oak"], subjectType: 'tasting_note', subjectName: 'Garrigue' },
                    { q: "How is the 2014 vintage generally described?", a: "A winemaker's vintage; lighter, cooler-toned, and for early drinking", o: ["A powerful, hot vintage", "An exceptional, balanced vintage", "A complete washout"], subjectType: 'vintage', subjectName: '2014 Southern Rhône Vintage' },
                    { q: "How is the 2009 vintage characterized?", a: "Rich, concentrated, and luscious with deep, ripe, sweet fruit", o: ["Lean, acidic, and elegant", "Light, fresh, and simple", "Harsh, tannic, and unbalanced"], subjectType: 'vintage', subjectName: '2009 Southern Rhône Vintage' },
                    { q: "What is a 'négociant' in the context of the wine market?", a: "A merchant who buys grapes or wine to bottle and sell under their own name", o: ["A winemaker who only uses estate-grown fruit", "A sommelier at a Michelin-starred restaurant", "A government official who regulates appellations"], subjectType: 'market', subjectName: 'Négociant' },
                    { q: "The wines from the 2017 vintage are often powerful and concentrated due to what primary factor?", a: "Very low yields caused by frost and drought", o: ["A long, cool growing season", "Perfect, moderate weather", "A large, healthy crop"], subjectType: 'vintage', subjectName: '2017 Southern Rhône Vintage' },
                    { q: "The Perrin family, pioneers of organic and biodynamic farming, owns which iconic estate?", a: "Château de Beaucastel", o: ["Château Rayas", "Domaine du Vieux Télégraphe", "Clos des Papes"], subjectType: 'producer', subjectName: 'Château de Beaucastel' },
                    { q: "The 2021 vintage was particularly difficult for which major grape variety due to severe spring frosts?", a: "Syrah", o: ["Grenache", "Mourvèdre", "Cinsault"], subjectType: 'vintage', subjectName: '2021 Southern Rhône Vintage' },
                    { q: "Which vintage is described as 'rich, plush, and opulent' due to a hot and dry summer?", a: "2015", o: ["2013", "2014", "2008"], subjectType: 'vintage', subjectName: '2015 Southern Rhône Vintage' },
                    { q: "Which vintage was so difficult, cool, and wet that it often required corrective chaptalization?", a: "2008", o: ["2007", "2010", "2016"], subjectType: 'vintage', subjectName: '2008 Southern Rhône Vintage' },
                    { q: "The white wine of which iconic producer is known for its exceptional aging potential of 25 years or more?", a: "Château de Beaucastel", o: ["Domaine Charvin", "Château Rayas", "Henri Bonneau"], subjectType: 'producer', subjectName: 'Château de Beaucastel' },
                    { q: "Who was the influential American importer who championed traditional Rhône producers like Auguste Clape and Domaine Tempier?", a: "Kermit Lynch", o: ["Robert Parker", "Eric Asimov", "Jancis Robinson"], subjectType: 'person', subjectName: 'Kermit Lynch' },
                    { q: "The powerful and structured 2019 vintage was marked by what climatic events?", a: "Two significant summer heatwaves", o: ["A very wet spring", "A cool and long summer", "Early autumn frosts"], subjectType: 'vintage', subjectName: '2019 Southern Rhône Vintage' },
                    { q: "Which Châteauneuf-du-Pape icon is known for a deliberately oxidative, long-aging style?", a: "Henri Bonneau", o: ["Clos des Papes", "Domaine de la Solitude", "Château de Beaucastel"], subjectType: 'producer', subjectName: 'Henri Bonneau' },
                    { q: "Which two powerful vintages are often compared for their structure and great aging potential?", a: "2010 and 2005", o: ["2014 and 2013", "2008 and 2021", "2011 and 2012"], subjectType: 'vintage', subjectName: '2010 Southern Rhône Vintage' },
                    { q: "The increasing frequency of extreme weather events places greater emphasis on what critical factor?", a: "The skill of the individual producer", o: ["The age of the vines", "The type of oak barrel used", "The market price of the wine"], subjectType: 'criticism', subjectName: 'Vintage Variation' },
                    { q: "Which producer is praised for a classic, pure, and unadorned style, often using whole-cluster fermentation?", a: "Domaine Charvin", o: ["Château de Beaucastel", "Domaine de la Janasse", "Clos Saint-Jean"], subjectType: 'producer', subjectName: 'Domaine Charvin' },
                    { q: "How is the 2022 vintage generally described?", a: "Concentrated and powerful from a hot, dry year, but with lower yields.", o: ["Light and acidic from a cool, wet year.", "A perfectly balanced, large-crop vintage.", "A vintage ruined by hail."], subjectType: 'vintage', subjectName: '2022 Southern Rhône Vintage' },
                    { q: "What is a key difference between the top cuvée of Clos des Papes and those of other iconic estates?", a: "They only make one red and one white, with no 'special' cuvée.", o: ["It is always 100% Mourvèdre.", "It is aged exclusively in new American oak.", "It is released 10 years after the vintage."], subjectType: 'producer', subjectName: 'Clos des Papes' },
                    { q: "The style of Vacqueyras wines is often described with what adjective, suggesting a powerful, tannic nature?", a: "Rustic", o: ["Elegant", "Delicate", "Sweet"], subjectType: 'wine_style', subjectName: 'Vacqueyras' },
                    { q: "Which vintage was defined by a near-perfect growing season with hot days, cool nights, and ideal rain timing?", a: "2016", o: ["2017", "2018", "2021"], subjectType: 'vintage', subjectName: '2016 Southern Rhône Vintage' },
                ]
            },
        };

        // This new object contains comprehensive flashcard data, separate from the quiz questions
        const flashcardData = {
            historian: [
                { q: "Who introduced the first cultivated vines to the south of France in the 4th century BC?", a: "Greek colonists near Marseille" },
                { q: "Which group systematically established viticulture throughout the Rhône Valley?", a: "The Romans" },
                { q: "The name 'Gigondas' is derived from what Latin word, and what did it mean?", a: "Jocunditas, meaning 'joy' or 'pleasure'" },
                { q: "Which city was founded in 35 BC for veterans of the Roman Legio II Gallica?", a: "Orange (Arausio)" },
                { q: "In what year did the Papacy relocate to Avignon?", a: "1309" },
                { q: "Which Pope established the summer residence and vineyards at Châteauneuf-du-Pape?", a: "Pope John XXII" },
                { q: "What was the early name for the wines from the papal vineyards?", a: "Vin du Pape ('Pope's Wine')" },
                { q: "What was the first formal quality control measure, introduced in 1650?", a: "Regulations by the 'Coste du Rhône' district" },
                { q: "What did the royal decree of 1737 mandate?", a: "The branding of barrels with 'C.D.R.' to certify origin" },
                { q: "When was phylloxera first documented in the Southern Rhône?", a: "1866" },
                { q: "Who was the visionary lawyer and proprietor of Château Fortia who led the fight against wine fraud?", a: "Baron Pierre Le Roy de Boiseaumarié" },
                { q: "In what year was the Syndicat des Vignerons de Châteauneuf-du-Pape formed?", a: "1923" },
                { q: "The rules drafted by Baron Le Roy became the model for what national system?", a: "The Appellation d'Origine Contrôlée (AOC) system" },
                { q: "What was the first wine appellation to be granted AOC status in France, and in what year?", a: "Châteauneuf-du-Pape, in 1936" },
                { q: "What is the historical basis of prestige for the Southern Rhône?", a: "The art of the blend" },
                { q: "What is the most imposing cultural landmark in Avignon, central to its wine history?", a: "The Palais des Papes (Palace of the Popes)" },
                { q: "What are the two key Roman monuments in the city of Orange?", a: "The Roman Theatre and the Triumphal Arch" },
                { q: "What is the name of the dramatic limestone peaks that define the terroir of Gigondas and Vacqueyras?", a: "The Dentelles de Montmirail" },
                { q: "Year Tavel was granted AOC status?", a: "1936" },
                { q: "Year Côtes du Rhône AOC was established?", a: "1937" },
                { q: "Year Lirac was granted AOC status?", a: "1947" },
                { q: "Year Côtes du Rhône Villages AOC was established?", a: "1967" },
                { q: "Year Gigondas was elevated to Cru status?", a: "1971" },
                { q: "Year Vacqueyras was elevated to Cru status?", a: "1990" },
                { q: "Year Rasteau's dry red wines were elevated to Cru status?", a: "2010" },
                { q: "Year Cairanne was elevated to Cru status?", a: "2016" },
                { q: "Year white wines were officially added to the Gigondas AOC?", a: "2022" },
                { q: "Year Laudun was elevated to Cru status?", a: "2024" },
                { q: "Which American importer was instrumental in popularizing traditional Rhône producers in the 20th century?", a: "Kermit Lynch" },
                { q: "What does 'C.D.R.' stand for on barrels from the 18th century?", a: "Côtes du Rhône" },
                { q: "The 14th-century relocation of the Papacy to Avignon is often called what?", a: "The Avignon Papacy or the Babylonian Captivity" },
                { q: "What is the name of the modern vineyard planted near the Palais des Papes?", a: "Clos de la Vigne du Palais des Papes" },
                { q: "Who manages the vineyard at the Palais des Papes?", a: "The Compagnons des Côtes du Rhône" },
                { q: "The Saracen Tower in Gigondas dates to which century?", a: "9th Century" },
                { q: "What was the primary motivation for the creation of the first quality control rules in the Rhône?", a: "To combat wine fraud" },
                { q: "Baron Le Roy's work codified the blend as the region's signature. True or False?", a: "True" },
                { q: "The modern quality revolution in the Southern Rhône is most associated with which decade?", a: "1980s" },
            ],
            terroir: [
                { q: "The Southern Rhône Valley was formed by the tectonic collision of the Massif Central and which other mountain range?", a: "The Alps" },
                { q: "What is the predominant type of parent rock in the region?", a: "Sedimentary (limestone and marl)" },
                { q: "What is the geological origin of the famous 'galets roulés'?", a: "Quaternary alluvial deposits from Alpine glaciers" },
                { q: "What is the primary viticultural benefit of limestone soils ('calcaires')?", a: "Excellent drainage and aromatic finesse" },
                { q: "What is the primary viticultural benefit of clay soils ('argileux')?", a: "Superior water retention" },
                { q: "What is the key thermal effect of 'galets roulés'?", a: "They absorb heat during the day and radiate it at night, accelerating ripening." },
                { q: "The wines of Château Rayas are famous for being grown on what type of soil?", a: "Sandy soils ('sables')" },
                { q: "What is the local term for compacted sandy or sandy-marl soils?", a: "Safres" },
                { q: "The Southern Rhône accounts for approximately what percentage of the entire Rhône Valley's wine production?", a: "95%" },
                { q: "What is the maximum vineyard elevation in Gigondas?", a: "Over 600 meters" },
                { q: "What is the approximate total of Growing Degree Days (GDD) for the Southern Rhône?", a: "1932 °C-days" },
                { q: "The Southern Rhône's GDD places it in which Winkler Index region?", a: "Region III" },
                { q: "What is the powerful, cold, and dry northwesterly wind that defines the region's climate?", a: "The Mistral" },
                { q: "What is the primary sanitary benefit of the Mistral wind?", a: "It dries the vine canopy, reducing pressure from fungal diseases." },
                { q: "What is the primary risk posed by the Mistral wind?", a: "It can damage young shoots and cause coulure (poor fruit set)." },
                { q: "What is the most significant viticultural risk in the region, exacerbated by climate change?", a: "Drought" },
                { q: "What is the name for the aromatic scrubland of wild herbs found throughout the region?", a: "Garrigue" },
                { q: "What is the average altitude in the heart of Châteauneuf-du-Pape?", a: "60-120 meters" },
                { q: "Which cru has vineyards reaching up to 400 meters, contributing to a cooler climate style?", a: "Vinsobres" },
                { q: "The vineyards on the slopes of what famous mountain can reach 600 meters?", a: "Mont Ventoux" },
                { q: "What is the approximate average annual rainfall in Avignon/Orange?", a: "613 mm" },
                { q: "What is the approximate average number of sunshine hours per year?", a: "2750 hours" },
                { q: "Which soil type is particularly well-suited for white grape varieties?", a: "Limestone soils (calcaires)" },
                { q: "Which soil type yields powerful, structured, and deeply colored red wines?", a: "Clay soils (argileux)" },
                { q: "Which soil type produces wines with more aromatic delicacy and finer tannins?", a: "Sandy soils (sableux)" },
                { q: "What is the parent material of the Dentelles de Montmirail?", a: "Mesozoic limestone and marl" },
                { q: "The sandy molasses of the Comtat Venaissin date to which geological period?", a: "Tertiary" },
                { q: "What is the primary viticultural challenge of sandy soils?", a: "Lower water-holding capacity" },
                { q: "What is the primary function of the clay subsoil beneath galets roulés?", a: "It acts as a water reservoir." },
                { q: "A high diurnal temperature range, found at higher altitudes, is crucial for developing what?", a: "Complex aromatics and vibrant acidity" },
                { q: "Which of the four French departments of the Southern Rhône is located on the right bank of the river?", a: "Gard" },
                { q: "Which of the four French departments of the Southern Rhône is located primarily on the left bank?", a: "Vaucluse" },
                { q: "Which month has the lowest average precipitation?", a: "July" },
                { q: "Which month has the highest average precipitation?", a: "November" },
                { q: "Which month has the highest average temperature?", a: "July" },
                { q: "What is the second most significant viticultural risk after drought?", a: "The Mistral wind" },
                { q: "What is the third most significant viticultural risk, especially with climate change?", a: "Spring Frost" },
                { q: "What is the French national geological survey organization?", a: "Bureau de Recherches Géologiques et Minières (BRGM)" },
                { q: "The name 'Dentelles de Montmirail' translates to what?", a: "'Lace of Montmirail'" },
                { q: "Which cru is located at the foot of the Dentelles de Montmirail?", a: "Vacqueyras" },
                { q: "The open geography of the Southern Rhône contrasts with what topographical feature of the Northern Rhône?", a: "Steep, narrow valleys" },
                { q: "What is the primary soil type of the La Crau plateau?", a: "Galets roulés over red clay" },
                { q: "Which famous mountain acts as a climatic barrier and creates unique microclimates?", a: "Mont Ventoux" },
                { q: "What is the general pH of the limestone soils in the region?", a: "Alkaline (high pH)" },
                { q: "The risk of spring frost is most acute in which type of location?", a: "Flat valley floors" },
                { q: "The thermal radiation from galets roulés leads to lower levels of what compound in grapes?", a: "Acidity (specifically malic acid)" },
                { q: "Which department is home to the city of Avignon?", a: "Vaucluse" },
                { q: "Which department is home to the city of Nîmes?", a: "Gard" },
                { q: "The city of Orange is located in which department?", a: "Vaucluse" },
                { q: "What is the general direction of the Mistral wind?", a: "Northwesterly (from the north/northwest)" },
            ],
            ampelographer: [
                { q: "What is the Spanish origin and name of Grenache?", a: "Aragón, where it is called Garnacha" },
                { q: "What are the three main color mutations of Grenache?", a: "Grenache Noir, Grenache Blanc, and Grenache Gris" },
                { q: "How many certified clones of Grenache Noir exist in France?", a: "24" },
                { q: "What is the growth habit of Grenache, making it suitable for Gobelet training?", a: "Upright" },
                { q: "What is 'coulure,' a condition to which Grenache is highly susceptible?", a: "The failure of flowers to develop into berries, leading to poor fruit set." },
                { q: "What are the two parent grapes of Syrah?", a: "Dureza and Mondeuse Blanche" },
                { q: "What is the growth habit of Syrah, which necessitates trellising?", a: "Trailing or drooping" },
                { q: "What is 'Syrah decline'?", a: "A condition where the graft union fails, eventually killing the vine." },
                { q: "What is the Spanish name for Mourvèdre?", a: "Monastrell" },
                { q: "What is the famous saying that describes the ideal growing conditions for Mourvèdre?", a: "'Its face in the hot sun and its feet in the water.'" },
                { q: "Which of the GSM trio is the latest to bud and ripen?", a: "Mourvèdre" },
                { q: "Which grape contributes waxy texture and notes of apricot and beeswax to white blends?", a: "Roussanne" },
                { q: "Which grape is valued for bringing freshness and high acidity to white blends?", a: "Picpoul or Bourboulenc" },
                { q: "Which grape is the primary component of the VDNs of Rasteau?", a: "Grenache Noir" },
                { q: "Which grape is the primary component of Muscat de Beaumes-de-Venise?", a: "Muscat à Petits Grains" },
                { q: "Which grape, also known as Brun Argenté, adds color and pepper to Châteauneuf-du-Pape blends?", a: "Vaccarèse" },
                { q: "Which grape adds spicy, peppery notes and acidity to a blend?", a: "Counoise" },
                { q: "Which grape adds floral aromatics and freshness?", a: "Muscardin" },
                { q: "Which grape contributes light color and high acidity?", a: "Terret Noir" },
                { q: "Which grape is known for high alcohol and floral notes in white blends?", a: "Clairette" },
                { q: "Which grape is the most widely planted white variety in the Southern Rhône?", a: "Grenache Blanc" },
                { q: "Which grape is known for its aromatic complexity and crispness in white blends?", a: "Picardan" },
                { q: "Which high-yielding grape is declining in acreage due to its rustic tannins?", a: "Carignan" },
                { q: "How many total grape varieties (counting color mutations) are permitted in Châteauneuf-du-Pape?", a: "18" },
                { q: "What is the Australian name for Syrah?", a: "Shiraz" },
                { q: "What is the Australian name for Mourvèdre?", a: "Mataro" },
                { q: "Which white grape is a color mutation of Grenache Noir?", a: "Grenache Blanc" },
                { q: "Which grape is known for its notes of green olive and bacon fat, especially in the Northern Rhône?", a: "Syrah" },
                { q: "Which grape is known for gamey, savory, and dark fruit notes when fully ripe?", a: "Mourvèdre" },
                { q: "Which grape is known for its generous red fruit (strawberry, raspberry) and high alcohol potential?", a: "Grenache" },
                { q: "Which grape is a key component in the rosés of Tavel?", a: "Grenache" },
                { q: "Which grape is often co-fermented with Viognier in the Northern Rhône?", a: "Syrah" },
                { q: "Which grape is known to oxidize easily, requiring careful handling in the winery?", a: "Grenache" },
                { q: "Which grape is a key component of white Hermitage?", a: "Roussanne (and Marsanne)" },
                { q: "Which grape is known for its high tannins and deep color, making it an excellent blending partner for Grenache?", a: "Mourvèdre" },
                { q: "Which of the main red grapes has a late budbreak, offering protection from spring frosts?", a: "Mourvèdre" },
                { q: "Which grape has an early budbreak, making it vulnerable to spring frosts?", a: "Grenache" },
                { q: "Which grape is particularly susceptible to lime-induced chlorosis?", a: "Syrah" },
                { q: "Which grape is prized for its drought resistance?", a: "Grenache" },
                { q: "Which grape's acreage is increasing in the Southern Rhône as a blending partner for Grenache?", a: "Syrah and Mourvèdre" },
            ],
            lawmaker: [
                { q: "What is the 'cahier des charges'?", a: "The official INAO document specifying the rules for an AOP." },
                { q: "What is the maximum permitted yield for red Châteauneuf-du-Pape AOC?", a: "35 hl/ha" },
                { q: "Which major cru forbids mechanical harvesting?", a: "Châteauneuf-du-Pape" },
                { q: "What is 'le tri'?", a: "The mandatory qualitative sorting of grapes required in many crus." },
                { q: "What is 'râpé' in the context of Châteauneuf-du-Pape law?", a: "The rejected portion of the harvest (min 2%) which must be declassified." },
                { q: "What is the maximum percentage of Grenache allowed in red Gigondas AOC?", a: "80%" },
                { q: "In Vacqueyras AOC, what is the minimum combined percentage of Syrah and Mourvèdre?", a: "20%" },
                { q: "What is 'mutage'?", a: "The process of adding grape spirit to stop fermentation, used for VDNs." },
                { q: "What is the minimum residual sugar for Muscat de Beaumes-de-Venise?", a: "100 g/L" },
                { q: "What does the term 'Tuilé' on a bottle of Rasteau VDN indicate?", a: "A tawny, oxidatively aged red VDN." },
                { q: "What does 'Hors d'âge' on a Rasteau VDN signify?", a: "A minimum of five years of aging." },
                { q: "Which Southern Rhône cru is dedicated exclusively to rosé?", a: "Tavel" },
                { q: "Is chaptalization common in the Southern Rhône?", a: "No, it is rarely necessary due to the warm climate." },
                { q: "Under what conditions is irrigation permitted in the crus?", a: "By prefectural decree during periods of severe drought." },
                { q: "What is the highest tier in the Rhône Valley quality pyramid?", a: "Cru" },
                { q: "How many villages are permitted to append their name to the Côtes du Rhône Villages AOP?", a: "22" },
                { q: "What is the minimum planting density in Châteauneuf-du-Pape?", a: "3,000 vines per hectare" },
                { q: "What is the minimum combined percentage of GSM grapes in a Vacqueyras blend?", a: "90%" },
                { q: "What is the release date for red Gigondas?", a: "March 15 of the year following harvest" },
                { q: "What is the minimum ABV of the neutral grape spirit used for mutage?", a: "96%" },
                { q: "What is the former name for the IGP classification?", a: "Vin de Pays" },
                { q: "Which was the most recently elevated Southern Rhône Cru as of late 2024?", a: "Laudun" },
                { q: "What is the maximum yield for the newly permitted white wines of Gigondas?", a: "40 hl/ha" },
                { q: "Which cru was the first to be recognized for all three colors of wine?", a: "Lirac" },
                { q: "What is the minimum potential alcohol for red Gigondas and Vacqueyras?", a: "12.5%" },
                { q: "What does the term 'Ambré' signify on a Rasteau VDN?", a: "An amber, oxidatively aged white VDN." },
                { q: "What does the term 'Grenat' signify on a Rasteau VDN?", a: "A young, fresh red VDN, aged reductively." },
                { q: "How many communes are covered by the Côtes du Rhône Villages AOP?", a: "95" },
                { q: "How many communes are covered by the basic Côtes du Rhône AOP?", a: "171" },
                { q: "What is the French governmental body that manages the AOC system?", a: "Institut National de l'Origine et de la Qualité (INAO)" },
                { q: "What is the name for the official growers' association of an appellation?", a: "Syndicat" },
            ],
            gastronome: [
                { q: "What are the four primary herbs in a typical 'Herbes de Provence' blend?", a: "Thyme, rosemary, savory, and oregano" },
                { q: "What is 'Petit épeautre de Haute-Provence'?", a: "A protected (PGI) ancient variety of spelt wheat." },
                { q: "What is a 'Daube Provençale'?", a: "A hearty beef stew slow-cooked in red wine and herbs." },
                { q: "What is 'rascasse'?", a: "A bony rockfish (scorpionfish) that is an essential ingredient for Bouillabaisse." },
                { q: "What is 'rouille'?", a: "A garlic-saffron mayonnaise traditionally served with Bouillabaisse." },
                { q: "What is 'tapenade' made from?", a: "Black olives, capers, and anchovies." },
                { q: "What is 'Marc de Provence'?", a: "A pomace brandy distilled from grape skins, seeds, and stems." },
                { q: "What is 'Pastis'?", a: "An anise-flavored spirit, the quintessential apéritif of Provence." },
                { q: "What is the 'louche'?", a: "The milky, opaque effect that occurs when water is added to Pastis." },
                { q: "What is 'Génépi'?", a: "An alpine liqueur made from wormwood plants." },
                { q: "What is 'Farigoule'?", a: "The local Provençal dialect word for wild thyme, and a liqueur made from it." },
                { q: "Which PGI melon is famous in the region?", a: "Melon de Cavaillon" },
                { q: "Which PDO fig is a local specialty?", a: "Figue de Solliès" },
                { q: "What is the primary cooking fat of Provence?", a: "Olive Oil" },
                { q: "What does the term 'garrigue' in wine refer to gastronomically?", a: "The scent of wild herbs like thyme and rosemary, mirroring Herbes de Provence." },
                { q: "What is a 'Tian de Légumes'?", a: "A baked gratin of thinly sliced summer vegetables." },
                { q: "What is the classic wine pairing for Agneau de Provence (roast lamb)?", a: "A robust red from Vacqueyras or Gigondas" },
                { q: "What is the classic wine pairing for Bouillabaisse?", a: "A structured, full-bodied rosé from Tavel" },
                { q: "What is the classic wine pairing for Tapenade?", a: "A crisp, dry rosé or Pastis" },
                { q: "What is the classic wine pairing for Tian de Légumes?", a: "A light, fruity Côtes du Rhône red or rosé" },
                { q: "What is the key flavoring that gives Bouillabaisse its distinctive color and aroma?", a: "Saffron" },
                { q: "What is the name for a pre-dinner drink meant to stimulate the appetite?", a: "Apéritif" },
                { q: "What is the name for a post-dinner drink meant to aid digestion?", a: "Digestif" },
                { q: "Which cultural activity is often associated with drinking Pastis?", a: "Playing pétanque" },
                { q: "Which PDO olive is a specialty of the region?", a: "Olive de Nîmes" },
            ],
            critic: [
                { q: "Describe the general character of a 'classic' Southern Rhône red wine.", a: "Generous, warm, with ripe red/dark fruit, notes of spice, and 'garrigue'." },
                { q: "Which vintage is considered a modern benchmark for its combination of power and freshness?", a: "2016" },
                { q: "Which vintage was severely affected by widespread spring frosts?", a: "2021" },
                { q: "Which vintage was highly variable due to rampant mildew pressure?", a: "2018" },
                { q: "Which vintage suffered from catastrophic 'coulure' in Grenache?", a: "2013" },
                { q: "Which producer is the icon for 100% Grenache from sandy soils?", a: "Château Rayas" },
                { q: "Which estate is famous for using a high proportion of Mourvèdre and all permitted varieties?", a: "Château de Beaucastel" },
                { q: "Who was the 'spiritual godfather' of the traditionalist style of Châteauneuf-du-Pape?", a: "Henri Bonneau" },
                { q: "Which estate is a benchmark for elegance and famously produces only one red and one white Châteauneuf-du-Pape?", a: "Clos des Papes" },
                { q: "Domaine du Vieux Télégraphe is most associated with which famous terroir?", a: "The La Crau plateau" },
                { q: "What is the top cuvée of Château de Beaucastel?", a: "Hommage à Jacques Perrin" },
                { q: "What is the top cuvée of the late Henri Bonneau?", a: "Réserve des Célestins" },
                { q: "What is the defining characteristic of a 'traditionalist' producer's cellar?", a: "Use of large, old, neutral vessels like foudres." },
                { q: "What are two hallmarks of a 'modernist' producer's approach?", a: "Destemming of grapes and the use of small, sometimes new, oak barrels." },
                { q: "Who was the influential American importer who championed traditional Rhône producers?", a: "Kermit Lynch" },
                { q: "Describe the 2010 vintage.", a: "Powerful, structured, and age-worthy with great depth." },
                { q: "Describe the 2007 vintage.", a: "Sensuous, opulent, and ripe with silky textures." },
                { q: "Describe the 2015 vintage.", a: "Rich, plush, and opulent with ripe, sweet fruit." },
                { q: "Describe the 2008 vintage.", a: "A difficult, cool, and wet vintage; wines are lean and acidic." },
                { q: "The wines of Château Rayas are often compared stylistically to which other French region?", a: "Burgundy" },
                { q: "Which family owns Château de Beaucastel?", a: "The Perrin family" },
                { q: "Which family owns Domaine du Vieux Télégraphe?", a: "The Brunier family" },
                { q: "Which family owns Château Rayas?", a: "The Reynaud family" },
                { q: "Who is the current winemaker at Clos des Papes?", a: "Paul-Vincent Avril" },
                { q: "Which 'Value Champion' is a top producer in Gigondas?", a: "Château de St-Cosme" },
                { q: "Which 'Value Champion' is a top producer in Vacqueyras?", a: "Domaine le Sang des Cailloux" },
                { q: "Which 'Rising Star' is known for natural wines in Tavel?", a: "Domaine l'Anglore" },
                { q: "What is a 'négociant'?", a: "A wine merchant who buys grapes or wine to bottle under their own label." },
                { q: "Describe the 2019 vintage.", a: "A hot year with two significant heatwaves, producing powerful, rich wines." },
                { q: "Describe the 2020 vintage.", a: "More balanced and fresh than 2019, with ripe fruit and fine tannins." },
                { q: "Describe the 2017 vintage.", a: "A year of extremes (frost and drought), resulting in concentrated wines from low yields." },
                { q: "Describe the 2009 vintage.", a: "Rich, concentrated, and luscious with deep, ripe, sweet fruit." },
                { q: "Describe the 2012 vintage.", a: "A classic, balanced, and charming year with approachable wines." },
                { q: "Describe the 2005 vintage.", a: "A classic, structured, and powerful vintage with great aging potential." },
                { q: "Describe the 2004 vintage.", a: "A firm, classic-styled vintage with good freshness." },
                { q: "The use of ovoid concrete tanks ('concrete eggs') is associated with which style of winemaking?", a: "Modernist" },
                { q: "Whole-cluster fermentation is a technique most often employed by which style of producer?", a: "Traditionalist" },
                { q: "Which Châteauneuf-du-Pape icon is known for an oxidative, long-aging style?", a: "Henri Bonneau" },
                { q: "Which two powerful vintages are often compared for their structure and aging potential?", a: "2010 and 2005" },
                { q: "Which 'Value Champion' from the Côtes du Rhône is known for biodynamic practices?", a: "Domaine Gramenon" },
            ]
        };

        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const modalContainer = document.getElementById('modal-container');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const aiSettingsBtn = document.getElementById('ai-settings-btn');

        let currentModule;
        let currentQuestionIndex;
        let score;
        let questions = [];
        let userTimeline = [];
        let historianAvailableEvents = [];
        let flashcardDeck = [];
        let currentFlashcardIndex = 0;
        let userApiKey = localStorage.getItem('geminiApiKey') || '';

        // --- Event Listeners ---
        document.querySelectorAll('.module-btn').forEach(button => {
            button.addEventListener('click', () => {
                const module = button.dataset.module;
                if (module === 'flashcard') {
                    showFlashcardTopicSelection();
                } else {
                    showInstructionalModal(module);
                }
            });
        });

        aiSettingsBtn.addEventListener('click', showAiSettingsModal);
        
        // --- Modal Functions ---
        function showModal(content) {
            modalContentWrapper.innerHTML = content;
            modalContainer.classList.remove('hidden');
        }

        function hideModal() {
            modalContainer.classList.add('hidden');
            modalContentWrapper.innerHTML = '';
        }
        
        function showWelcomeModal() {
            if (sessionStorage.getItem('welcomed')) return;
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Welcome to the Gauntlet!</h2>
                    <p class="mb-4 text-gray-300">This is "The Southern Rhône: A Wine Master's Challenge," an interactive study game designed for advanced wine students.</p>
                    <p class="mb-6 text-gray-300">Test your knowledge across history, terroir, grapes, law, and more. All questions are derived from a comprehensive research document on the region. Good luck!</p>
                    <button onclick="closeWelcomeModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Begin</button>
                </div>
            `;
            showModal(content);
        }

        function closeWelcomeModal() {
            sessionStorage.setItem('welcomed', 'true');
            hideModal();
        }

        function showInstructionalModal(module) {
            currentModule = module;
            const moduleData = gameData[module];
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">${moduleData.title}</h2>
                    <p class="mb-6 text-gray-300">${moduleData.instructions}</p>
                    <button onclick="startGame()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Challenge</button>
                </div>
            `;
            showModal(content);
        }

        function showEndGameModal() {
            const moduleData = gameData[currentModule];
            const content = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Module Complete!</h2>
                    <p class="text-lg mb-2 text-gray-300">You completed "${moduleData.title}".</p>
                    <p class="text-4xl font-bold mb-6">Score: ${score} / ${questions.length}</p>
                    <p class="mb-6 text-gray-400">Play again to get a new set of questions and improve your score!</p>
                    <button onclick="returnToMenu()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                </div>
            `;
            showModal(content);
        }

        function showAiSettingsModal() {
            const content = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">AI Settings</h2>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    <p class="mb-4 text-gray-300">To use the AI-powered features, please enter your Google AI Studio API key. You can get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 hover:underline">aistudio.google.com/app/apikey</a>.</p>
                    <p class="text-sm text-yellow-400 mb-4">Security Reminder: Treat your API key like a password. It is saved in your browser's local storage for convenience but is not transmitted anywhere else.</p>
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" value="${userApiKey}">
                    </div>
                    <button onclick="saveApiKey()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Save and Close</button>
                </div>
            `;
            showModal(content);
        }
        
        function saveApiKey() {
            userApiKey = document.getElementById('api-key-input').value;
            localStorage.setItem('geminiApiKey', userApiKey);
            hideModal();
        }

        // --- Game Flow ---
        function startGame() {
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;

            if (currentModule === 'historian') {
                questions = shuffleArray([...gameData.historian.questions]);
                loadHistorianQuestion();
            } else {
                // NEW LOGIC START: Filter out correctly answered questions
                const allModuleQuestions = [...gameData[currentModule].questions];
                const correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                const correctQuestionsForModule = correctLog[currentModule] || [];

                let availableQuestions = allModuleQuestions.filter(q => !correctQuestionsForModule.includes(q.q));

                // If all questions have been answered correctly, reset progress for this module
                if (availableQuestions.length === 0 && allModuleQuestions.length > 0) {
                    alert("Congratulations! You've mastered this module. Your progress for this section will now be reset.");
                    correctLog[currentModule] = [];
                    localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));
                    availableQuestions = allModuleQuestions;
                }
                
                questions = shuffleArray(availableQuestions).slice(0, 10);
                // NEW LOGIC END
                loadQuestion();
            }
        }

        function returnToMenu() {
            hideModal();
            gameScreen.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            gameScreen.innerHTML = '';
        }

        // --- Multiple Choice Logic ---
        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            const options = shuffleArray([q.a, ...q.o]);
            
            gameScreen.innerHTML = `
                <div class="w-full max-w-3xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-right text-gray-400">${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-8 rounded-lg">
                        <p class="text-xl md:text-2xl font-medium mb-6">${q.q}</p>
                        <div class="space-y-4">
                            ${options.map(option => `
                                <button class="answer-btn block w-full text-left bg-gray-700 p-4 rounded-lg hover:bg-purple-700 transition-colors duration-200" onclick="checkAnswer('${option.replace(/'/g, "\\'")}')">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-container" class="mt-6"></div>
                    </div>
                </div>
            `;
        }
        
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }
        
        function generateAiButtonHtml(question) {
            if (!question.subjectType || !question.subjectName) {
                return '';
            }
            
            let buttonText = `Dive Deeper on ${question.subjectName}`;
            if (question.subjectType === 'dish' || question.subjectType === 'wine_pairing') {
                 buttonText = `Explain the Pairing for ${question.subjectName}`;
            }

            return `<button onclick="handleAiRequest('${question.subjectType}', '${question.subjectName.replace(/'/g, "\\'")}')" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded text-sm">${buttonText}</button>`;
        }

        function checkAnswer(selectedOption) {
            const q = questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.a;
            const feedbackContainer = document.getElementById('feedback-container');
            
            let feedbackHtml = '';
            if (isCorrect) {
                score++;
                // NEW LOGIC START: Save correctly answered question to localStorage
                const questionText = q.q;
                let correctLog = JSON.parse(localStorage.getItem('correctlyAnsweredQuestions')) || {};
                if (!correctLog[currentModule]) {
                    correctLog[currentModule] = [];
                }
                if (!correctLog[currentModule].includes(questionText)) {
                    correctLog[currentModule].push(questionText);
                }
                localStorage.setItem('correctlyAnsweredQuestions', JSON.stringify(correctLog));
                // NEW LOGIC END

                feedbackHtml = `<div class="p-4 rounded-lg bg-green-900 border border-green-700">
                                    <p class="font-bold text-green-300">Correct!</p>
                                    <p class="text-green-400">${q.a}</p>
                                    ${generateAiButtonHtml(q)}
                                </div>`;
            } else {
                feedbackHtml = `<div class="p-4 rounded-lg bg-red-900 border border-red-700">
                                    <p class="font-bold text-red-300">Incorrect.</p>
                                    <p class="text-red-400">The correct answer was: ${q.a}</p>
                                </div>`;
            }

            feedbackContainer.innerHTML = feedbackHtml;
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            feedbackContainer.innerHTML += `<button onclick="nextQuestion()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>`;
        }
        
        // --- Historian's Scroll Logic ---
        function loadHistorianQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndGameModal();
                return;
            }

            const q = questions[currentQuestionIndex];
            userTimeline = [];
            
            // Add a stable, unique ID to each event for the current question
            const eventsWithIds = q.events.map((event, index) => ({ ...event, id: `${currentQuestionIndex}-${index}` }));
            historianAvailableEvents = shuffleArray(eventsWithIds);

            gameScreen.innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="flex justify-between items-center mb-2">
                        <button onclick="returnToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm">← Menu</button>
                        <p class="text-center text-gray-400">Question ${currentQuestionIndex + 1} / ${questions.length} | Score: ${score}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <p class="text-xl text-center font-medium mb-6">${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Available Events</h3>
                                <div id="available-events" class="space-y-2">
                                    ${historianAvailableEvents.map(event => `
                                        <button data-id="${event.id}" class="timeline-item w-full text-left bg-gray-700 p-3 rounded hover:bg-purple-800 transition-colors duration-200">
                                            ${event.text}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-2 text-purple-400 text-center">Your Timeline (Earliest to Latest)</h3>
                                <div id="user-timeline" class="space-y-2 bg-gray-900 p-3 rounded-lg min-h-[200px]">
                                    </div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="submit-timeline" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg" onclick="checkTimeline()">Submit</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelectorAll('#available-events .timeline-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const eventId = e.currentTarget.dataset.id;
                    const event = historianAvailableEvents.find(ev => ev.id === eventId);
                    if (event && !userTimeline.some(e => e.id === event.id)) {
                        userTimeline.push(event);
                        e.currentTarget.classList.add('selected', 'opacity-50', 'cursor-not-allowed');
                        e.currentTarget.disabled = true;
                        renderUserTimeline();
                    }
                });
            });
        }
        
        function renderUserTimeline() {
            const timelineContainer = document.getElementById('user-timeline');
            timelineContainer.innerHTML = userTimeline.map((event, index) => `
                <div class="bg-purple-900 p-3 rounded flex items-center justify-between">
                    <span>${index + 1}. ${event.text}</span>
                    <button class="text-red-400 hover:text-red-200 font-bold" onclick="removeFromTimeline('${event.id}')">&times;</button>
                </div>
            `).join('');
        }

        function removeFromTimeline(eventId) {
            const indexToRemove = userTimeline.findIndex(event => event.id === eventId);

            if (indexToRemove > -1) {
                userTimeline.splice(indexToRemove, 1);
                const buttonToReEnable = document.querySelector(`#available-events .timeline-item[data-id="${eventId}"]`);
                if (buttonToReEnable) {
                    buttonToReEnable.disabled = false;
                    buttonToReEnable.classList.remove('selected', 'opacity-50', 'cursor-not-allowed');
                }
                renderUserTimeline();
            }
        }

        function checkTimeline() {
            const q = questions[currentQuestionIndex];
            const correctTimeline = [...q.events].sort((a, b) => a.date - b.date);
            let isCompletelyCorrect = userTimeline.length === correctTimeline.length;
            
            if (isCompletelyCorrect) {
                for (let i = 0; i < correctTimeline.length; i++) {
                    if (userTimeline[i].text !== correctTimeline[i].text) {
                        isCompletelyCorrect = false;
                        break;
                    }
                }
            }
            
            if(isCompletelyCorrect) {
                score++;
            }

            const userTimelineHtml = userTimeline.map((event, i) => {
                const isEventInCorrectPosition = correctTimeline[i] && correctTimeline[i].text === event.text;
                const borderColor = isEventInCorrectPosition ? 'border-green-500' : 'border-red-500';
                return `<li class="p-2 bg-gray-700 rounded border-2 ${borderColor}">${event.text}</li>`;
            }).join('');

            const correctTimelineHtml = correctTimeline.map(e => 
                `<li class="p-2 bg-gray-700 rounded border-2 border-green-500">${e.text} <span class="text-gray-400 text-sm">(${e.date > 0 ? e.date : Math.abs(e.date) + ' BC'})</span></li>`
            ).join('');
            
            const feedbackContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 ${isCompletelyCorrect ? 'text-green-400' : 'text-yellow-400'}">${isCompletelyCorrect ? 'Perfect!' : 'Review Your Timeline'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Your Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${userTimelineHtml}
                            </ol>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-purple-400">Correct Timeline</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                ${correctTimelineHtml}
                            </ol>
                        </div>
                    </div>
                    <button onclick="nextHistorianQuestion()" class="mt-6 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Continue</button>
                </div>
            `;
            showModal(feedbackContent);
        }

        function nextHistorianQuestion() {
            hideModal();
            currentQuestionIndex++;
            loadHistorianQuestion();
        }

        // --- Flashcard Logic ---
        function showFlashcardTopicSelection() {
            const topics = Object.keys(flashcardData); // Use flashcardData keys
            const content = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-purple-400">Build Your Flashcard Deck</h2>
                    <p class="mb-6 text-gray-300">Select the topics you want to study. These decks cover the entire source document.</p>
                    <div id="flashcard-topics" class="space-y-2 mb-4">
                        ${topics.map(topic => `
                            <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500" data-topic="${topic}">
                                <span class="ml-3 text-white">${gameData[topic].title}</span>
                            </label>
                        `).join('')}
                    </div>
                     <label class="flex items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 cursor-pointer mb-6">
                        <input type="checkbox" id="select-all-topics" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500">
                        <span class="ml-3 text-white font-bold">Select All</span>
                    </label>
                    <button onclick="startFlashcardSession()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Start Studying</button>
                </div>
            `;
            showModal(content);
            
            document.getElementById('select-all-topics').addEventListener('change', (e) => {
                document.querySelectorAll('#flashcard-topics input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }

        function startFlashcardSession() {
            flashcardDeck = [];
            const selectedTopics = Array.from(document.querySelectorAll('#flashcard-topics input:checked')).map(cb => cb.dataset.topic);

            if (selectedTopics.length === 0) {
                alert("Please select at least one topic.");
                return;
            }

            selectedTopics.forEach(topic => {
                if (flashcardData[topic]) {
                    flashcardDeck.push(...flashcardData[topic]);
                }
            });

            flashcardDeck = shuffleArray(flashcardDeck);
            currentFlashcardIndex = 0;
            hideModal();
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            loadFlashcard();
        }

        function loadFlashcard() {
            if (flashcardDeck.length === 0) {
                gameScreen.innerHTML = `<div class="text-center">
                    <p class="text-2xl mb-4">No topics selected.</p>
                    <button onclick="returnToMenu()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Main Menu</button>
                </div>`;
                return;
            }
            const card = flashcardDeck[currentFlashcardIndex];
            gameScreen.innerHTML = `
                <div class="w-full max-w-2xl flex flex-col items-center">
                    <p class="text-gray-400 mb-4">${currentFlashcardIndex + 1} / ${flashcardDeck.length}</p>
                    <div class="flashcard-container w-full h-80 mb-6">
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-face flashcard-front text-2xl font-semibold text-center">${card.q}</div>
                            <div class="flashcard-face flashcard-back text-xl text-center overflow-y-auto">${card.a}</div>
                        </div>
                    </div>
                    <div class="flex justify-between w-full">
                        <button id="prev-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">&larr; Previous</button>
                        <button onclick="returnToMenu()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">End Session</button>
                        <button id="next-card" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded">Next &rarr;</button>
                    </div>
                </div>
            `;
            
            document.getElementById('prev-card').addEventListener('click', () => {
                if (currentFlashcardIndex > 0) {
                    currentFlashcardIndex--;
                    loadFlashcard();
                }
            });
            document.getElementById('next-card').addEventListener('click', () => {
                if (currentFlashcardIndex < flashcardDeck.length - 1) {
                    currentFlashcardIndex++;
                    loadFlashcard();
                }
            });
        }
        
        // --- AI Integration ---
        async function handleAiRequest(subjectType, subjectName) {
            if (!userApiKey) {
                showModal(`<div class="p-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400">API Key Required</h2>
                    <p class="mb-4 text-gray-300">Please set your Google AI API key in the 'AI Settings' on the main menu to use this feature.</p>
                    <button onclick="hideModal()" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                </div>`);
                return;
            }

            let prompt;
            let title;
            const region = "Southern Rhône Valley";

            switch (subjectType) {
                case 'grape':
                    title = `Ampelography Profile: ${subjectName}`;
                    prompt = `You are a master ampelographer and wine educator with a specialization in the ${region}. Your task is to profile the grape: ${subjectName}. Your response must follow this strict pyramid of importance: 1. The grape's specific expression and role within the ${region}. 2. Its general viticultural characteristics as they manifest in the ${region}'s climate. 3. Its history within the region. Your entire response must be framed through the lens of the ${region}. Synthesize information from authoritative sources like Inter Rhône, JancisRobinson.com, and academic viticultural texts, but always prioritize the context of the ${region}. Structure your response with the following sections: Overview and History in the Rhône, Viticultural Characteristics in the Rhône, and Typical Southern Rhône Wine Profile. Format the output in simple HTML.`;
                    break;
                case 'wine':
                case 'producer':
                case 'vintage':
                case 'place':
                    title = `Critic's Focus: ${subjectName}`;
                    prompt = `You are a world-renowned wine critic specializing exclusively in the wines of the ${region}. Your task is to write a professional profile for the following iconic ${region} topic: ${subjectName}. Your analysis must adhere to a strict pyramid of importance: 1) The specific subject's style or character. 2) The character of its specific appellation within the ${region}. 3) The general characteristics of the ${region}. Do not mention wines from other regions unless making a direct, essential stylistic comparison. Synthesize information from authoritative sources like Vinous, The Wine Advocate, and JancisRobinson.com, but ensure the final note is your own expert synthesis. Assume a recent, high-quality vintage for any wine examples. Format in simple HTML.`;
                    break;
                case 'dish':
                case 'wine_pairing': // A specific type for questions about pairings
                    title = `Gastronomic Pairing: ${subjectName}`;
                    prompt = `You are a master sommelier and food theorist specializing in the cuisine and wine of Provence and the ${region}. Your task is to explain the classic wine pairing for the dish: ${subjectName}. Your explanation must follow this strict pyramid of importance: 1. The specific characteristics of the dish as found in the region. 2. The typical profile of a ${region} wine that pairs with it. 3. The underlying gastronomic principles (complement, contrast, texture) that make the pairing successful within the context of the region's culture. Synthesize information from expert sources, but frame your entire response within the context of the ${region}. Format in simple HTML.`;
                    break;
                case 'ingredient':
                    title = `Ingredient Focus: ${subjectName}`;
                    prompt = `You are a food and wine expert specializing in the cuisine of Provence and the ${region}. Your task is to provide a detailed overview of the ingredient: ${subjectName}. Your response must follow this strict pyramid of importance: 1. How this ingredient is used in the local cuisine of the ${region}. 2. Its typical flavor and aromatic profile. 3. How its profile might be reflected in or complement the local wines (e.g., the concept of 'garrigue'), but do not focus on specific pairings unless it is intrinsic to the ingredient itself. Synthesize from authoritative sources. Format in simple HTML.`;
                    break;
                case 'spirit':
                case 'liqueur':
                    title = `Beverage Profile: ${subjectName}`;
                    prompt = `You are an expert on the spirits and liqueurs of France, with a specialization in the ${region}. Your task is to provide a detailed overview of ${subjectName}. Your response must follow this strict pyramid of importance: 1. How ${subjectName} is made and consumed specifically within the ${region}. 2. Its key ingredients and typical flavor profile. 3. Its cultural significance in the ${region}. Do not focus on wine pairings unless it is a key part of its consumption. Synthesize information from authoritative sources. Format in simple HTML.`;
                    break;
                default:
                    title = `Expert Overview: ${subjectName}`;
                    prompt = `You are a wine and food expert specializing in the ${region}. Provide a concise and informative overview of the following topic: ${subjectName}, ensuring your response is strictly relevant to its context within the ${region}. Format in simple HTML.`;
            }
            
            showModal(`<div class="p-6 text-center">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">Generating AI Response...</h2>
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-gray-400">Please wait, contacting the master sommelier...</p>
            </div>`);

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const aiContent = `
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-purple-400">${title}</h2>
                                <button onclick="hideModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div class="prose prose-invert prose-purple max-w-none">${text.replace(/\n/g, '<br>')}</div>
                        </div>`;
                    showModal(aiContent);
                } else {
                     throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                const errorContent = `
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-400">Error</h2>
                        <p class="mb-4 text-gray-300">Could not generate AI response. Please check your API key and network connection.</p>
                        <p class="text-sm text-gray-500 bg-gray-900 p-2 rounded">${error.message}</p>
                        <button onclick="hideModal()" class="mt-4 w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">Close</button>
                    </div>`;
                showModal(errorContent);
            }
        }

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Initial Load ---
        window.onload = showWelcomeModal;

    </script>
</body>
</html>
